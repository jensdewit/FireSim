#!/bin/sh
#
# Compiled firewall script generated by Shorewall-perl 4.0.13 - Tue Oct  7 13:34:40 2008
#
#     This program is under GPL [http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt]
#
#     (c) 1999,2000,2001,2002,2003,2004,2005,2006,2007 - Tom Eastep (teastep@shorewall.net)
#
#	Options are:
#
#	    -n				  Don't alter Routing
#	    -v and -q			  Standard Shorewall Verbosity control
#
#	Commands are:
#
#	   start			  Starts the firewall
#          refresh                        Refresh the firewall
#	   restart			  Restarts the firewall
#	   reload			  Reload the firewall
#	   clear			  Removes all firewall rules
#	   stop				  Stops the firewall
#	   status			  Displays firewall status
#	   version			  Displays the version of Shorewall that
#	   				  generated this program
#
################################################################################
# Functions imported from /usr/share/shorewall/lib.base
################################################################################
#
# Message to stderr
#
error_message() # $* = Error Message
{
   echo "   $@" >&2
}

#
# Conditionally produce message
#
progress_message() # $* = Message
{
    local timestamp=

    if [ $VERBOSE -gt 1 ]; then
	[ -n "$TIMESTAMP" ] && timestamp="$(date +%H:%M:%S) "
	echo "${timestamp}$@"
    fi
}

progress_message2() # $* = Message
{
    local timestamp=

    if [ $VERBOSE -gt 0 ]; then
	[ -n "$TIMESTAMP" ] && timestamp="$(date +%H:%M:%S) "
	echo "${timestamp}$@"
    fi
}

progress_message3() # $* = Message
{
    local timestamp=

    if [ $VERBOSE -ge 0 ]; then
	[ -n "$TIMESTAMP" ] && timestamp="$(date +%H:%M:%S) "
	echo "${timestamp}$@"
    fi
}

#
# Split a colon-separated list into a space-separated list
#
split() {
    local ifs=$IFS
    IFS=:
    echo $*
    IFS=$ifs
}

#
# Search a list looking for a match -- returns zero if a match found
# 1 otherwise
#
list_search() # $1 = element to search for , $2-$n = list
{
    local e=$1

    while [ $# -gt 1 ]; do
	shift
	[ "x$e" = "x$1" ] && return 0
    done

    return 1
}

#
# Suppress all output for a command
#
qt()
{
    "$@" >/dev/null 2>&1
}

qt1()
{
    local status

    while [ 1 ]; do
	"$@" >/dev/null 2>&1
	status=$?
	[ $status -ne 4 ] && return $status
    done
}

#
# Determine if Shorewall is "running"
#
shorewall_is_started() {
    qt1 $IPTABLES -L shorewall -n
}

#
# Echos the fully-qualified name of the calling shell program
#
my_pathname() {
    cd $(dirname $0)
    echo $PWD/$(basename $0)
}

#
# Source a user exit file if it exists
#
run_user_exit() # $1 = file name
{
    local user_exit=$(find_file $1)

    if [ -f $user_exit ]; then
	progress_message "Processing $user_exit ..."
	. $user_exit
    fi
}

#
# Set a standard chain's policy
#
setpolicy() # $1 = name of chain, $2 = policy
{
    run_iptables -P $1 $2
}

#
# Set a standard chain to enable established and related connections
#
setcontinue() # $1 = name of chain
{
    run_iptables -A $1 -m state --state ESTABLISHED,RELATED -j ACCEPT
}

#
# Flush one of the NAT table chains
#
flushnat() # $1 = name of chain
{
    run_iptables -t nat -F $1
}

#
# Flush one of the Mangle table chains
#
flushmangle() # $1 = name of chain
{
    run_iptables -t mangle -F $1
}

#
# Flush and delete all user-defined chains in the filter table
#
deleteallchains() {
    run_iptables -F
    run_iptables -X
}

#
# Load a Kernel Module -- assumes that the variable 'moduledirectories' contains
#                         a space-separated list of directories to search for
#                         the module and that 'moduleloader' contains the
#                         module loader command.
#
loadmodule() # $1 = module name, $2 - * arguments
{
    local modulename=$1
    local modulefile
    local suffix

    if ! list_search $modulename $DONT_LOAD $MODULES; then
	shift

	for suffix in $MODULE_SUFFIX ; do
	    for directory in $moduledirectories; do
		modulefile=$directory/${modulename}.${suffix}

		if [ -f $modulefile ]; then
		    case $moduleloader in
			insmod)
			    insmod $modulefile $*
			    ;;
			*)
			    modprobe $modulename $*
			    ;;
		    esac
		    break 2
		fi
	    done
	done
    fi
}

#
# Reload the Modules
#
reload_kernel_modules() {

    local save_modules_dir=$MODULESDIR
    local directory
    local moduledirectories=
    local moduleloader=modprobe

    if ! qt mywhich modprobe; then
	moduleloader=insmod
    fi

    [ -n "${MODULE_SUFFIX:=o gz ko o.gz ko.gz}" ]

    [ -z "$MODULESDIR" ] && MODULESDIR=/lib/modules/$(uname -r)/kernel/net/ipv4/netfilter:/lib/modules/$(uname -r)/kernel/net/netfilter
    MODULES=$(lsmod | cut -d ' ' -f1)

    for directory in $(split $MODULESDIR); do
	[ -d $directory ] && moduledirectories="$moduledirectories $directory"
    done

    [ -n "$moduledirectories" ] && while read command; do
	eval $command
    done

    MODULESDIR=$save_modules_dir
}

#
# Load kernel modules required for Shorewall
#
load_kernel_modules() # $1 = Yes, if we are to save moduleinfo in $VARDIR
{
    local save_modules_dir=$MODULESDIR
    local directory
    local moduledirectories=
    local moduleloader=modprobe
    local savemoduleinfo=${1:-Yes} # So old compiled scripts still work

    if ! qt mywhich modprobe; then
	moduleloader=insmod
    fi

    [ -n "${MODULE_SUFFIX:=o gz ko o.gz ko.gz}" ]

    [ -z "$MODULESDIR" ] && \
	MODULESDIR=/lib/modules/$(uname -r)/kernel/net/ipv4/netfilter:/lib/modules/$(uname -r)/kernel/net/netfilter

    for directory in $(split $MODULESDIR); do
	[ -d $directory ] && moduledirectories="$moduledirectories $directory"
    done

    modules=$(find_file modules)

    if [ -f $modules -a -n "$moduledirectories" ]; then
	MODULES=$(lsmod | cut -d ' ' -f1)
	progress_message "Loading Modules..."
	. $modules
	if [ $savemoduleinfo = Yes ]; then
	    [ -d ${VARDIR} ] || mkdir -p ${VARDIR}
	    echo MODULESDIR="$MODULESDIR" > ${VARDIR}/.modulesdir
	    cp -f $modules ${VARDIR}/.modules
	fi
    elif [ $savemoduleinfo = Yes ]; then
	[ -d ${VARDIR} ] || mkdir -p ${VARDIR}
	> ${VARDIR}/.modulesdir
	> ${VARDIR}/.modules
    fi

    MODULESDIR=$save_modules_dir
}

#
#  Note: The following set of IP address manipulation functions have anomalous
#        behavior when the shell only supports 32-bit signed arithmetic and
#        the IP address is 128.0.0.0 or 128.0.0.1.
#

LEFTSHIFT='<<'

#
# Convert an IP address in dot quad format to an integer
#
decodeaddr() {
    local x
    local temp=0
    local ifs=$IFS

    IFS=.

    for x in $1; do
	temp=$(( $(( $temp $LEFTSHIFT 8 )) | $x ))
    done

    echo $temp

    IFS=$ifs
}

#
# convert an integer to dot quad format
#
encodeaddr() {
    addr=$1
    local x
    local y=$(($addr & 255))

    for x in 1 2 3 ; do
	addr=$(($addr >> 8))
	y=$(($addr & 255)).$y
    done

    echo $y
}

#
# Netmask from CIDR
#
ip_netmask() {
    local vlsm=${1#*/}

    [ $vlsm -eq 0 ] && echo 0 || echo $(( -1 $LEFTSHIFT $(( 32 - $vlsm )) ))
}

#
# Network address from CIDR
#
ip_network() {
    local decodedaddr=$(decodeaddr ${1%/*})
    local netmask=$(ip_netmask $1)

    echo $(encodeaddr $(($decodedaddr & $netmask)))
}

#
# The following hack is supplied to compensate for the fact that many of
# the popular light-weight Bourne shell derivatives don't support XOR ("^").
#
ip_broadcast() {
    local x=$(( 32 - ${1#*/} ))

    [ $x -eq 32 ] && echo -1 || echo $(( $(( 1 $LEFTSHIFT $x )) - 1 ))
}

#
# Calculate broadcast address from CIDR
#
broadcastaddress() {
    local decodedaddr=$(decodeaddr ${1%/*})
    local netmask=$(ip_netmask $1)
    local broadcast=$(ip_broadcast $1)

    echo $(encodeaddr $(( $(($decodedaddr & $netmask)) | $broadcast )))
}

#
# Test for network membership
#
in_network() # $1 = IP address, $2 = CIDR network
{
    local netmask=$(ip_netmask $2)
    #
    # Use string comparison rather than numeric to work around a broken BusyBox ash on OpenWRT
    #
    test $(( $(decodeaddr $1) & $netmask)) = $(( $(decodeaddr ${2%/*}) & $netmask ))
}

#
# Query NetFilter about the existence of a filter chain
#
chain_exists() # $1 = chain name
{
    qt1 $IPTABLES -L $1 -n
}

#
# Find the value 'dev' in the passed arguments then echo the next value
#

find_device() {
    while [ $# -gt 1 ]; do
	[ "x$1" = xdev ] && echo $2 && return
	shift
    done
}

#
# Find the value 'via' in the passed arguments then echo the next value
#

find_gateway() {
    while [ $# -gt 1 ]; do
	[ "x$1" = xvia ] && echo $2 && return
	shift
    done
}

#
# Find the value 'mtu' in the passed arguments then echo the next value
#

find_mtu() {
    while [ $# -gt 1 ]; do
	[ "x$1" = xmtu ] && echo $2 && return
	shift
    done
}

#
# Find the value 'peer' in the passed arguments then echo the next value up to
# "/"
#

find_peer() {
    while [ $# -gt 1 ]; do
	[ "x$1" = xpeer ] && echo ${2%/*} && return
	shift
    done
}

#
# Find the interfaces that have a route to the passed address - the default
# route is not used.
#

find_rt_interface() {
    ip route list | while read addr rest; do
	case $addr in
	    */*)
		in_network ${1%/*} $addr && echo $(find_device $rest)
		;;
	    default)
		;;
	    *)
		if [ "$addr" = "$1" -o "$addr/32" = "$1" ]; then
		    echo $(find_device $rest)
		fi
		;;
	esac
    done
}

#
# Try to find the gateway through an interface looking for 'nexthop'

find_nexthop() # $1 = interface
{
    echo $(find_gateway `ip route list | grep "[[:space:]]nexthop.* $1"`)
}

#
# Find the default route's interface
#
find_default_interface() {
    ip route list | while read first rest; do
	[ "$first" = default ] && echo $(find_device $rest) && return
    done
}

#
# Echo the name of the interface(s) that will be used to send to the
# passed address
#

find_interface_by_address() {
    local dev="$(find_rt_interface $1)"
    local first rest

    [ -z "$dev" ] && dev=$(find_default_interface)

    [ -n "$dev" ] && echo $dev
}

#
# Find the interface with the passed MAC address
#

find_interface_by_mac() {
    local mac=$1 first second rest dev

    ip link list | while read first second rest; do
	case $first in
	    *:)
                dev=$second
		;;
	    *)
	        if [ "$second" = $mac ]; then
		    echo ${dev%:}
		    return
		fi
	esac
    done
}

#
# Determine if Interface is up
#
interface_is_up() {
    [ -n "$(ip link list dev $1 2> /dev/null | grep -e '[<,]UP[,>]')" ]
}

#
# Find interface address--returns the first IP address assigned to the passed
# device
#
find_first_interface_address() # $1 = interface
{
    #
    # get the line of output containing the first IP address
    #
    addr=$(ip -f inet addr show $1 2> /dev/null | grep 'inet .* global' | head -n1)
    #
    # If there wasn't one, bail out now
    #
    [ -n "$addr" ] || fatal_error "Can't determine the IP address of $1"
    #
    # Strip off the trailing VLSM mask (or the peer IP in case of a P-t-P link)
    # along with everything else on the line
    #
    echo $addr | sed 's/\s*inet //;s/\/.*//;s/ peer.*//'
}

find_first_interface_address_if_any() # $1 = interface
{
    #
    # get the line of output containing the first IP address
    #
    addr=$(ip -f inet addr show $1 2> /dev/null | grep 'inet .* global' | head -n1)
    #
    # Strip off the trailing VLSM mask (or the peer IP in case of a P-t-P link)
    # along with everything else on the line
    #
    [ -n "$addr" ] && echo $addr | sed 's/\s*inet //;s/\/.*//;s/ peer.*//' || echo 0.0.0.0
}

#
# Determine if interface is usable from a Netfilter prespective
#
interface_is_usable() # $1 = interface
{
    interface_is_up $1 && [ "$(find_first_interface_address_if_any $1)" != 0.0.0.0 ] && run_isusable_exit $1
}

#
# Find interface addresses--returns the set of addresses assigned to the passed
# device
#
find_interface_addresses() # $1 = interface
{
    ip -f inet addr show $1 2> /dev/null | grep inet\  | sed 's/\s*inet //;s/\/.*//;s/ peer.*//'
}

#
#  echo the list of networks routed out of a given interface
#
get_routed_networks() # $1 = interface name, $2-n = Fatal error message
{
    local address
    local rest

    ip route show dev $1 2> /dev/null |
	while read address rest; do
	    case "$address" in
		default)
		    if [ $# -gt 1 ]; then
			shift
			fatal_error "$@"
		    else
			echo "WARNING: default route ignored on interface $1" >&2
		    fi
		    ;;
		multicast|broadcast|prohibit|nat|throw|nexthop)
		    ;;
		*)
		    echo $address
		    ;;
	    esac
        done
}

get_interface_bcasts() # $1 = interface
{
    local addresses=

    ip -f inet addr show dev $1 2> /dev/null | grep 'inet.*brd' | sed 's/inet.*brd //; s/scope.*//;' | sort -u
}

#
# Internal version of 'which'
#
mywhich() {
    local dir

    for dir in $(split $PATH); do
	if [ -x $dir/$1 ]; then
	    echo $dir/$1
	    return 0
	fi
    done

    return 2
}

#
# Find a File -- For relative file name, look in each ${CONFIG_PATH} then ${CONFDIR}
#
find_file()
{
    local saveifs= directory

    case $1 in
	/*)
	    echo $1
	    ;;
	*)
	    for directory in $(split $CONFIG_PATH); do
		if [ -f $directory/$1 ]; then
		    echo $directory/$1
		    return
		fi
	    done

	    echo ${CONFDIR}/$1
	    ;;
    esac
}

#
# Set the Shorewall state
#
set_state () # $1 = state
{
    echo "$1 ($(date))" > ${VARDIR}/state
}

#
# Perform variable substitution on the passed argument and echo the result
#
expand() # $@ = contents of variable which may be the name of another variable
{
    eval echo \"$@\"
}

#
# Function for including one file into another
#
INCLUDE() {
    . $(find_file $(expand $@))
}

#
# Delete IP address
#
del_ip_addr() # $1 = address, $2 = interface
{
    [ $(find_first_interface_address_if_any $2) = $1 ] || qt ip addr del $1 dev $2
}

# Add IP Aliases
#
add_ip_aliases() # $* = List of addresses
{
    local addresses external interface inet cidr rest val arping=$(mywhich arping)

    address_details()
    {
	#
	# Folks feel uneasy if they don't see all of the same
	# decoration on these IP addresses that they see when their
	# distro's net config tool adds them. In an attempt to reduce
	# the anxiety level, we have the following code which sets
	# the VLSM and BRD from an existing address in the same networks
	#
	# Get all of the lines that contain inet addresses with broadcast
	#
	ip -f inet addr show $interface 2> /dev/null | grep 'inet.*brd' | while read inet cidr rest ; do
	    case $cidr in
		*/*)
		    if in_network $external $cidr; then
			echo "/${cidr#*/} brd $(broadcastaddress $cidr)"
			break
		    fi
		    ;;
	    esac
	done
    }

    do_one()
    {
	val=$(address_details)

	ip addr add ${external}${val} dev $interface $label
	[ -n "$arping" ] && qt $arping -U -c 2 -I $interface $external
	echo "$external $interface" >> $VARDIR/nat
	[ -n "$label" ] && label="with $label"
	progress_message "   IP Address $external added to interface $interface $label"
    }

    progress_message "Adding IP Addresses..."

    while [ $# -gt 0 ]; do
	external=$1
	interface=$2
	label=

	if [ "$interface" != "${interface%:*}" ]; then
	    label="${interface#*:}"
	    interface="${interface%:*}"
	    label="label $interface:$label"
	fi

	shift 2

	list_search $external $(find_interface_addresses $interface) || do_one
    done
}

detect_gateway() # $1 = interface
{
    local interface=$1
    #
    # First assume that this is some sort of point-to-point interface
    #
    gateway=$( find_peer $(ip addr list $interface ) )
    #
    # Maybe there's a default route through this gateway already
    #
    [ -n "$gateway" ] || gateway=$(find_gateway $(ip route list dev $interface))
    #
    # Last hope -- is there a load-balancing route through the interface?
    #
    [ -n "$gateway" ] || gateway=$(find_nexthop $interface)
    #
    # Be sure we found one
    #
    [ -n "$gateway" ] && echo $gateway
}

#
# Disable IPV6
#
disable_ipv6() {
    local foo="$(ip -f inet6 addr list 2> /dev/null)"

    if [ -n "$foo" ]; then
	if qt mywhich ip6tables; then
	    ip6tables -P FORWARD DROP
	    ip6tables -P INPUT DROP
	    ip6tables -P OUTPUT DROP
	    ip6tables -F
	    ip6tables -X
	    ip6tables -A OUTPUT -o lo -j ACCEPT
	    ip6tables -A INPUT -i lo -j ACCEPT
	else
	    error_message "WARNING: DISABLE_IPV6=Yes in shorewall.conf but this system does not appear to have ip6tables"
	fi
    fi
}

# Function to truncate a string -- It uses 'cut -b -<n>'
# rather than ${v:first:last} because light-weight shells like ash and
# dash do not support that form of expansion.
#

truncate() # $1 = length
{
    cut -b -${1}
}

delete_tc1()
{
    clear_one_tc() {
        tc qdisc del dev $1 root 2> /dev/null
        tc qdisc del dev $1 ingress 2> /dev/null

    }

    run_user_exit tcclear

    run_ip link list | \
    while read inx interface details; do
        case $inx in
            [0-9]*)
                clear_one_tc ${interface%:}
                ;;
            *)
                ;;
        esac
    done
}

#
# Detect a device's MTU -- echos the passed device's MTU
#
get_device_mtu() # $1 = device
{
    local output="$(ip link list dev $1 2> /dev/null)" # quotes required for /bin/ash

    if [ -n "$output" ]; then
	echo $(find_mtu $output)
    else
	echo 1500
    fi
}

#
# Version of the above that doesn't generate any output for MTU 1500.
# Generates 'mtu <mtu+>' otherwise, where <mtu+> is the device's MTU + 100
#
get_device_mtu1() # $1 = device
{
    local output="$(ip link list dev $1 2> /dev/null)" # quotes required for /bin/ash
    local mtu

    if [ -n "$output" ]; then
	mtu=$(find_mtu $output)
	if [ -n "$mtu" ]; then
	    [ $mtu = 1500 ] || echo mtu $(($mtu + 100))
	fi
    fi

}

#
# Undo changes to routing
#
undo_routing() {

    if [ -z "$NOROUTES"  ]; then
	#
	# Restore rt_tables database
	#
	if [ -f ${VARDIR}/rt_tables ]; then
	    [ -w /etc/iproute2/rt_table -a -z "$KEEP_RT_TABLES" ] && cp -f ${VARDIR}/rt_tables /etc/iproute2/ && progress_message "/etc/iproute2/rt_tables database restored"
	    rm -f ${VARDIR}/rt_tables
	fi
	#
	# Restore the rest of the routing table
	#
	if [ -f ${VARDIR}/undo_routing ]; then
	    . ${VARDIR}/undo_routing
	    progress_message "Shorewall-generated routing tables and routing rules removed"
	    rm -f ${VARDIR}/undo_routing
	fi
    fi

}

restore_default_route() {
    if [ -z "$NOROUTES" -a -f ${VARDIR}/default_route ]; then
	local default_route= route

	while read route ; do
	    case $route in
		default*)
		    if [ -n "$default_route" ]; then
			case "$default_route" in
			    *metric*)
		                #
		                # Don't restore a route with a metric -- we only replace the one with metric == 0
		                #
				qt ip route delete default metric 0 && \
				    progress_message "Default Route with metric 0 deleted"
				;;
			    *)
				qt ip route replace $default_route && \
				    progress_message "Default Route (${default_route# }) restored"
				;;
			esac

			break
		    fi

		    default_route="$default_route $route"
		    ;;
		*)
		    default_route="$default_route $route"
		    ;;
	    esac
	done < ${VARDIR}/default_route

	rm -f ${VARDIR}/default_route
    fi
}

#
# Determine how to do "echo -e"
#

find_echo() {
    local result

    result=$(echo "a\tb")
    [ ${#result} -eq 3 ] && { echo echo; return; }

    result=$(echo -e "a\tb")
    [ ${#result} -eq 3 ] && { echo "echo -e"; return; }

    result=$(which echo)
    [ -n "$result" ] && { echo "$result -e"; return; }

    echo echo
}
################################################################################
# End of functions imported from /usr/share/shorewall/lib.base
################################################################################

run_init_exit() {
    
    progress_message2 Processing /etc/shorewall/init ...

    #
    # Shorewall version 4 - Init File
    #
    # /etc/shorewall/init
    #
    #	Add commands below that you want to be executed at the beginning of
    #	a "shorewall start" or "shorewall restart" command.
    #
    # For additional information, see
    # http://shorewall.net/shorewall_extension_scripts.htm
    #
    ###############################################################################
    #LAST LINE -- ADD YOUR ENTRIES BEFORE THIS ONE -- DO NOT REMOVE
}

run_isusable_exit() {
    true
}

run_start_exit() {
    
    progress_message2 Processing /etc/shorewall/start ...

    #
    # Shorewall version 4 - Start File
    #
    # /etc/shorewall/start
    #
    #	Add commands below that you want to be executed after shorewall has
    #	been started or restarted.
    #
    # See http://shorewall.net/shorewall_extension_scripts.htm for additional
    # information.
    #
    ###############################################################################
    #LAST LINE - ADD YOUR ENTRIES ABOVE THIS ONE - DO NOT REMOVE
}

run_tcclear_exit() {
    true
}

run_started_exit() {
    
    progress_message2 Processing /etc/shorewall/started ...

    #
    # Shorewall version 4 - Started File
    #
    # /etc/shorewall/started
    #
    #	Add commands below that you want to be executed after shorewall has
    #	been completely started or restarted. The difference between this
    #	extension script and /etc/shorewall/start is that this one is invoked
    #	after delayed loading of the blacklist (DELAYBLACKLISTLOAD=Yes) and
    #	after the 'shorewall' chain has been created (thus signaling that the
    #	firewall is completely up.
    #
    #	This script should not change the firewall configuration directly but
    #	may do so indirectly by running /sbin/shorewall with the 'nolock'
    #	option.
    #
    # See http://shorewall.net/shorewall_extension_scripts.htm for additional
    # information.
    #
    ###############################################################################
    #LAST LINE - ADD YOUR ENTRIES ABOVE THIS ONE - DO NOT REMOVE
}

run_stop_exit() {
    
    progress_message2 Processing /etc/shorewall/stop ...

    #
    # Shorewall version 4 - Stop File
    #
    # /etc/shorewall/stop
    #
    #	Add commands below that you want to be executed at the beginning of a
    #	"shorewall stop" command.
    #
    # See http://shorewall.net/shorewall_extension_scripts.htm for additional
    # information.
    #
    ###############################################################################
    #LAST LINE - ADD YOUR ENTRIES ABOVE THIS ONE - DO NOT REMOVE
}

run_stopped_exit() {
    
    progress_message2 Processing /etc/shorewall/stopped ...

    #
    # Shorewall version 4 - Stopped File
    #
    # /etc/shorewall/stopped
    #
    #	Add commands below that you want to be executed at the completion of a
    #	"shorewall stop" command.
    #
    # See http://shorewall.net/shorewall_extension_scripts.htm for additional
    # information.
    #
    ###############################################################################
    #LAST LINE - ADD YOUR ENTRIES ABOVE THIS ONE - DO NOT REMOVE
}

run_clear_exit() {
    true
}

run_refresh_exit() {
    true
}

run_refreshed_exit() {
    true
}

#
# This function initializes the global variables used by the program
#
initialize()
{
    #
    # These variables are required by the library functions called in this script
    #
    SHAREDIR=/usr/share/shorewall
    CONFDIR=/etc/shorewall
    PRODUCT='Shorewall'
    [ -f ${CONFDIR}/vardir ] && . ${CONFDIR}/vardir
    CONFIG_PATH="/etc/shorewall/:/usr/share/shorewall/"
    [ -n "${VARDIR:=/var/lib/shorewall}" ]
    TEMPFILE=
    DISABLE_IPV6="Yes"
    MODULESDIR=""
    MODULE_SUFFIX="o gz ko o.gz ko.gz"
    LOGFORMAT="Shorewall:%s:%s:"
    SUBSYSLOCK="/var/lock/shorewall"
    LOCKFILE=""
    LOGLIMIT=""
    LOGTAGONLY=""
    LOGRULENUMBERS=""
    [ -n "${COMMAND:=restart}" ]
    [ -n "${VERBOSE:=0}" ]
    [ -n "${RESTOREFILE:=restore}" ]
    [ -n "$LOGFORMAT" ] || LOGFORMAT="Shorewall:%s:%s:"
    VERSION="4.0.13"
    PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin:/usr/local/sbin"
    TERMINATOR=fatal_error
    DONT_LOAD=""

    [ -z "$IPTABLES" ] && IPTABLES=$(mywhich iptables) # /sbin/shorewall exports IPTABLES
    [ -n "$IPTABLES" -a -x "$IPTABLES" ] || startup_error "Can't find iptables executable"
    IPTABLES_RESTORE=${IPTABLES}-restore
    [ -x "$IPTABLES_RESTORE" ] || startup_error "$IPTABLES_RESTORE does not exist or is not executable"
    
    progress_message2 Processing /etc/shorewall/params ...

    #
    # Shorewall verson 4 - Params Fil
    #
    # /etc/shorewall/params
    #
    #	Assign any variables that you need here.
    #
    #	It is suggested that variable names begin with an upper case letter
    #	to distinguish them from variables used internally within the
    #	Shorewall programs
    #
    #	Example:
    #
    #		NET_IF=eth0
    #		NET_BCAST=130.252.100.255
    #		NET_OPTIONS=routefilter,norfc1918
    #
    #	Example (/etc/shorewall/interfaces record):
    #
    #		net	$NET_IF		$NET_BCAST	$NET_OPTIONS
    #
    #	The result will be the same as if the record had been written
    #
    #		net	eth0		130.252.100.255	routefilter,norfc1918
    #
    ###############################################################################

    ##############################
    # Clients77 143.129.77.32/27 #
    ##############################

    EVDVELDE=143.129.77.37

    JBERGS=143.129.77.35

    KSMOLDER=143.129.77.34

    CLIENTS=143.129.77.32/27

    ###########################
    # Servers 143.129.77.0/27 #
    ###########################

    CALLIOPE=143.129.77.1

    ERATO=143.129.77.11
    OLDERATO=143.129.77.3

    ESP=143.129.77.7

    EUTERPE=143.129.77.9

    LABCAM=143.129.77.12

    PATSSWITCH=143.129.77.29

    THALIA=143.129.77.2

    PRINTER=$THALIA

    UPS=143.129.77.14

    URANIA=143.129.77.5

    SERVERS=143.129.77.0/27


    #################################
    # STUDENT LABO 143.129.77.80/28 #
    #################################

    EVDVELDE_NAT=143.129.80.37

    PATSSTUDENT=143.129.80.253

    STUDENTLAB=143.129.80.0/24

    #######################
    # TERRAN 10.0.0.0/24  #
    #######################


    CONTROLLER=10.0.0.253

    CONTROLSWITCH=10.0.0.251

    TERRAN=10.0.0.0/24

    TESTSWITCH=10.0.0.252


    ###################################################
    # UA 143.129.0.0/16 143.169.0.0/16 146.175.0.0/16 #
    ###################################################

    UANET1=143.129.254.99

    UANET2=143.169.254.99

    UANET=$UANET1,$UANET2

    UA_CDE=143.169.0.0/16
    UA_CMI=143.129.0.0/16
    UA_CST=146.175.0.0/16
    UA=$UA_CDE,$UA_CMI,$UA_CST


    ###########
    # GENERAL #
    ###########

    LOG=ULOG
    OPS=$EVDVELDE,$JBERGS,$KSMOLDER

    #LAST LINE - ADD YOUR ENTRIES ABOVE THIS ONE - DO NOT REMOVE
    STOPPING=

    #
    # The library requires that ${VARDIR} exist
    #
    [ -d ${VARDIR} ] || mkdir -p ${VARDIR}

    #
    # Recent kernels are difficult to configure -- we see state match omitted a lot so we check for it here
    #
    qt1 $IPTABLES -N foox1234
    qt1 $IPTABLES -A foox1234 -m state --state ESTABLISHED,RELATED -j ACCEPT
    result=$?
    qt1 $IPTABLES -F foox1234
    qt1 $IPTABLES -X foox1234
    [ $result = 0 ] || startup_error "Your kernel/iptables do not include state match support. No version of Shorewall will run on this system"

}

#
# Stop/restore the firewall after an error or because of a 'stop' or 'clear' command
#
stop_firewall() {

    deletechain() {
	qt1 $IPTABLES -L $1 -n && qt1 $IPTABLES -F $1 && qt1 $IPTABLES -X $1
    }

    deleteallchains() {
	do_iptables -F
	do_iptables -X
    }

    setcontinue() {
	do_iptables -A $1 -m state --state ESTABLISHED,RELATED -j ACCEPT
    }

    delete_nat() {
	do_iptables -t nat -F
	do_iptables -t nat -X

	if [ -f ${VARDIR}/nat ]; then
	    while read external interface; do
		del_ip_addr $external $interface
	    done < ${VARDIR}/nat

	    rm -f ${VARDIR}/nat
	fi
    }

    case $COMMAND in
	stop|clear|restore)
	    ;;
	*)
	    set +x

	    case $COMMAND in
		start)
		    logger -p kern.err "ERROR:$PRODUCT start failed"
		    ;;
		restart)
		    logger -p kern.err "ERROR:$PRODUCT restart failed"
		    ;;
		restore)
		    logger -p kern.err "ERROR:$PRODUCT restore failed"
		    ;;
	    esac

	    if [ "$RESTOREFILE" = NONE ]; then
		COMMAND=clear
		clear_firewall
		echo "$PRODUCT Cleared"

		kill $$
		exit 2
	    else
		RESTOREPATH=${VARDIR}/$RESTOREFILE

		if [ -x $RESTOREPATH ]; then

		    if [ -x ${RESTOREPATH}-ipsets ]; then
			progress_message2 Restoring Ipsets...
			#
			# We must purge iptables to be sure that there are no
			# references to ipsets
			#
			for table in mangle nat filter; do
			    do_iptables -t $table -F
			    do_iptables -t $table -X
			done

			${RESTOREPATH}-ipsets
		    fi

		    echo Restoring ${PRODUCT:=Shorewall}...

		    if $RESTOREPATH restore; then
			echo "$PRODUCT restored from $RESTOREPATH"
			set_state "Started"
		    else
			set_state "Unknown"
		    fi

		    kill $$
		    exit 2
		fi
	    fi
	    ;;
    esac

    set_state "Stopping"

    STOPPING="Yes"

    TERMINATOR=

    deletechain shorewall

    run_stop_exit

    run_iptables -t mangle -F
    run_iptables -t mangle -X
    for chain in PREROUTING INPUT FORWARD POSTROUTING; do
	qt1 $IPTABLES -t mangle -P $chain ACCEPT
    done

    run_iptables -t raw -F
    run_iptables -t raw -X
    for chain in PREROUTING OUTPUT; do
	qt1 $IPTABLES -t raw -P $chain ACCEPT
    done

    delete_nat
    for chain in PREROUTING POSTROUTING OUTPUT; do
	qt1 $IPTABLES -t nat -P $chain ACCEPT
    done

    if [ -f ${VARDIR}/proxyarp ]; then
	while read address interface external haveroute; do
	    qt arp -i $external -d $address pub
	    [ -z "${haveroute}${NOROUTES}" ] && qt ip route del $address dev $interface
	    f=/proc/sys/net/ipv4/conf/$interface/proxy_arp
	    [ -f $f ] && echo 0 > $f
	done < ${VARDIR}/proxyarp
    fi

    rm -f ${VARDIR}/proxyarp

    delete_tc1
    undo_routing
    restore_default_route
    for chain in INPUT OUTPUT FORWARD; do
	setpolicy $chain DROP
    done

    deleteallchains

    $IPTABLES -A INPUT -i cln   -j ACCEPT
    $IPTABLES -A OUTPUT -o cln   -j ACCEPT
    $IPTABLES -A FORWARD -i cln   -j ACCEPT
    do_iptables -A INPUT  -i lo -j ACCEPT
    do_iptables -A OUTPUT -o lo -j ACCEPT
    do_iptables -A OUTPUT -o lo -j ACCEPT
    do_iptables -A INPUT  -p udp -i lab --dport 67:68 -j ACCEPT
    do_iptables -A OUTPUT -p udp -o lab --dport 67:68 -j ACCEPT
    do_iptables -A FORWARD -p udp -i lab -o lab --dport 67:68 -j ACCEPT
    do_iptables -A INPUT  -p udp -i cln --dport 67:68 -j ACCEPT
    do_iptables -A OUTPUT -p udp -o cln --dport 67:68 -j ACCEPT
    do_iptables -A FORWARD -p udp -i cln -o cln --dport 67:68 -j ACCEPT
    do_iptables -A INPUT  -p udp -i srv --dport 67:68 -j ACCEPT
    do_iptables -A OUTPUT -p udp -o srv --dport 67:68 -j ACCEPT
    do_iptables -A FORWARD -p udp -i srv -o srv --dport 67:68 -j ACCEPT
    do_iptables -A INPUT  -p udp -i trn --dport 67:68 -j ACCEPT
    do_iptables -A OUTPUT -p udp -o trn --dport 67:68 -j ACCEPT
    do_iptables -A FORWARD -p udp -i trn -o trn --dport 67:68 -j ACCEPT

    echo 1 > /proc/sys/net/ipv4/ip_forward
    progress_message2 IP Forwarding Enabled
    run_stopped_exit

    set_state "Stopped"

    logger -p kern.info "$PRODUCT Stopped"

    case $COMMAND in
    stop|clear)
	;;
    *)
	#
	# The firewall is being stopped when we were trying to do something
	# else. Kill the shell in case we're running in a subshell
	#
	kill $$
	;;
    esac
}

#
# Clear Proxy Arp
#
delete_proxyarp() {
    if [ -f ${VARDIR}/proxyarp ]; then
	while read address interface external haveroute; do
	    qt arp -i $external -d $address pub
	    [ -z "${haveroute}${NOROUTES}" ] && qt ip route del $address dev $interface
	    f=/proc/sys/net/ipv4/conf/$interface/proxy_arp
	    [ -f $f ] && echo 0 > $f
	done < ${VARDIR}/proxyarp
    fi

    rm -f ${VARDIR}/proxyarp
}

#
# Remove all Shorewall-added rules
#
clear_firewall() {
    stop_firewall

    setpolicy INPUT ACCEPT
    setpolicy FORWARD ACCEPT
    setpolicy OUTPUT ACCEPT

    run_iptables -F

    echo 1 > /proc/sys/net/ipv4/ip_forward

    if [ -n "$DISABLE_IPV6" ]; then
	if qt mywhich ip6tables; then
	    ip6tables -P INPUT   ACCEPT 2> /dev/null
	    ip6tables -P OUTPUT  ACCEPT 2> /dev/null
	    ip6tables -P FORWARD ACCEPT 2> /dev/null
	fi
    fi

    run_clear_exit

    set_state "Cleared"

    logger -p kern.info "$PRODUCT Cleared"
}

#
# Issue a message and stop/restore the firewall
#
fatal_error()
{
    echo "   ERROR: $@" >&2
    stop_firewall
    [ -n "$TEMPFILE" ] && rm -f $TEMPFILE
    exit 2
}

#
# Issue a message and stop
#
startup_error() # $* = Error Message
{
    echo "   ERROR: $@" >&2
    case $COMMAND in
        start)
	    logger -p kern.err "ERROR:$PRODUCT start failed"
	    ;;
	restart)
	    logger -p kern.err "ERROR:$PRODUCT restart failed"
	    ;;
	restore)
	    logger -p kern.err "ERROR:$PRODUCT restore failed"
	    ;;
    esac

    kill $$
    exit 2
}

#
# Run iptables and if an error occurs, stop/restore the firewall
#
run_iptables()
{
    local status

    while [ 1 ]; do
	$IPTABLES $@
	status=$?
	[ $status -ne 4 ] && break
    done

    if [ $status -ne 0 ]; then
        error_message "ERROR: Command \"$IPTABLES $@\" Failed"
	stop_firewall
        exit 2
    fi
}

#
# Run iptables retrying exit status 4
#
do_iptables()
{
    local status

    while [ 1 ]; do
	$IPTABLES $@
	status=$?
	[ $status -ne 4 ] && return $status;
    done
}

#
# Run iptables and if an error occurs, stop/restore the firewall
#
run_ip()
{
    if ! ip $@; then
	error_message "ERROR: Command \"ip $@\" Failed"
	stop_firewall
	exit 2
    fi
}

#
# Run tc and if an error occurs, stop/restore the firewall
#
run_tc() {
    if ! tc $@ ; then
	error_message "ERROR: Command \"tc $@\" Failed"
	stop_firewall
	exit 2
    fi
}

restore_dynamic_rules() {
    if [ -f ${VARDIR}/save ]; then
	progress_message2 "Setting up dynamic rules..."
	rangematch='source IP range'
	while read target ignore1 ignore2 address ignore3 rest; do
	    case $target in
		DROP|reject|logdrop|logreject)
		    case $rest in
			$rangematch*)
			    run_iptables -A dynamic -m iprange --src-range ${rest#source IP range} -j $target
			    ;;
			*)
			    if [ -z "$rest" ]; then
				run_iptables -A dynamic -s $address -j $target
			    else
				error_message "WARNING: Unable to restore dynamic rule \"$target $ignore1 $ignore2 $address $ignore3 $rest\""
			    fi
			    ;;
		    esac
		    ;;
	    esac
	done < ${VARDIR}/save
    fi
}

#
# Get a list of all configured broadcast addresses on the system
#
get_all_bcasts()
{
    ip -f inet addr show 2> /dev/null | grep 'inet.*brd' | sed 's/inet.*brd //; s/scope.*//;' | sort -u
}

#
# Run the .iptables_restore_input as a set of discrete iptables commands
#
debug_restore_input() {
    local first second rest table chain
    #
    # Clear the ruleset 
    #
    qt1 $IPTABLES -t mangle -F
    qt1 $IPTABLES -t mangle -X

    for chain in PREROUTING INPUT FORWARD POSTROUTING; do
	qt1 $IPTABLES -t mangle -P $chain ACCEPT
    done

    qt1 $IPTABLES -t raw    -F
    qt1 $IPTABLES -t raw    -X

    for chain in PREROUTING OUTPUT; do
	qt1 $IPTABLES -t raw -P $chain ACCEPT
    done

    run_iptables -t nat -F
    run_iptables -t nat -X

    for chain in PREROUTING POSTROUTING OUTPUT; do
	qt1 $IPTABLES -t nat -P $chain ACCEPT
    done

    qt1 $IPTABLES -t filter -F
    qt1 $IPTABLES -t filter -X

    for chain in INPUT FORWARD OUTPUT; do
	qt1 $IPTABLES -t filter -P $chain -P ACCEPT
    done

    while read first second rest; do
	case $first in
	    -*)
		#
		# We can't call run_iptables() here because the rules may contain quoted strings
		#
		eval $IPTABLES -t $table $first $second $rest

		if [ $? -ne 0 ]; then
		    error_message "ERROR: Command \"$IPTABLES $first $second $rest\" Failed"
		    stop_firewall
		    exit 2
		fi
		;;
	    :*)
		chain=${first#:}

		if [ "x$second" = x- ]; then
		    do_iptables -t $table -N $chain
		else
		    do_iptables -t $table -P $chain $second
		fi

		if [ $? -ne 0 ]; then
		    error_message "ERROR: Command \"$IPTABLES $first $second $rest\" Failed"
		    stop_firewall
		    exit 2
		fi
		;;
	    #
	    # This grotesque hack with the table names works around a bug/feature with ash
	    #
	    '*'raw)
		table=raw
		;;
	    '*'mangle)
		table=mangle
		;;
	    '*'nat)
		table=nat
		;;
	    '*'filter)
		table=filter
		;;
	esac
    done
}

#
# Clear Routing and Traffic Shaping
#
clear_routing_and_traffic_shaping() {
    
    progress_message2 Initializing...

    load_kernel_modules Yes

    addr=$(ip -f inet addr show net70 2> /dev/null | grep 'inet ' | head -n1)
    if [ -n "$addr" ]; then
	addr=$(echo $addr | sed 's/inet //;s/\/.*//;s/ peer.*//')
	for network in 10.0.0.0/8 176.16.0.0/12 192.168.0.0/16; do
	    if in_network $addr $network; then
		error_message "WARNING: The 'norfc1918' option has been specified on an interface with an RFC 1918 address. Interface:net70"
	    fi
	done
    fi

    [ "$COMMAND" = refresh ] && run_refresh_exit || run_init_exit

    qt1 $IPTABLES -L shorewall -n && qt1 $IPTABLES -F shorewall && qt1 $IPTABLES -X shorewall

    delete_proxyarp

    if [ -f ${VARDIR}/nat ]; then
	while read external interface; do
	    del_ip_addr $external $interface
	done < ${VARDIR}/nat

	rm -f ${VARDIR}/nat
    fi

    delete_tc1

    disable_ipv6

}

#
# Setup Routing and Traffic Shaping
#
setup_routing_and_traffic_shaping() {
    
    progress_message2 Setting up ARP filtering...

    progress_message2 Setting up Route Filtering...

    for file in /proc/sys/net/ipv4/conf/*; do
	[ -f $file/rp_filter ] && echo 0 > $file/rp_filter
    done
    echo 1 > /proc/sys/net/ipv4/conf/all/rp_filter
    echo 0 > /proc/sys/net/ipv4/conf/default/rp_filter
    [ -n "$NOROUTES" ] || ip route flush cache
    
    progress_message2 Setting up Martian Logging...

    for file in /proc/sys/net/ipv4/conf/*; do
	[ -f $file/log_martians ] && echo 0 > $file/log_martians
    done
    echo 0 > /proc/sys/net/ipv4/conf/all/log_martians
    echo 0 > /proc/sys/net/ipv4/conf/default/log_martians
    
    progress_message2 Setting up Accept Source Routing...

    progress_message2 Setting up Proxy ARP...

    if [ -z "$NOROUTES" ]; then
	#
	# Undo any changes made since the last time that we [re]started -- this will not restore the default route
	#
	undo_routing
	#
	# Save current routing table database so that it can be restored later
	#
	cp /etc/iproute2/rt_tables ${VARDIR}/
	#
	# Capture the default route(s) if we don't have it (them) already.
	#
	[ -f ${VARDIR}/default_route ] || ip route list | grep -E '^\s*(default |nexthop )' > ${VARDIR}/default_route
	#
	# Initialize the file that holds 'undo' commands
	#
	> ${VARDIR}/undo_routing
	
	progress_message2 Adding Providers...

	DEFAULT_ROUTE=
	#
	# Add Provider UA70 (1)
	#
	if interface_is_usable net70; then
	    qt ip route flush table 1
	    echo "qt ip route flush table 1" >> ${VARDIR}/undo_routing
	    ip route show table main | while read net route; do
		case $net in
		    default|nexthop)
			;;
		    *)
			case $(find_device $route) in
			    net70|cln|lab|srv|trn|vpn)
				run_ip route add table 1 $net $route
				;;
			esac
			;;
		esac
	    done

	    run_ip route add default via 143.129.70.254 dev net70 table 1
	    qt ip rule del fwmark 1
	    run_ip rule add fwmark 1 pref 10000 table 1
	    echo "qt ip rule del fwmark 1" >> ${VARDIR}/undo_routing
	    
	    rulenum=0

	    find_interface_addresses net70 | while read address; do
		qt ip rule del from $address
		run_ip rule add from $address pref $(( 20000 + $rulenum )) table 1
		echo "qt ip rule del from $address" >> ${VARDIR}/undo_routing
		rulenum=$(($rulenum + 1))
	    done
	    
	    progress_message "   Provider UA70 (1) Added"

	else
	    fatal_error "Interface net70 is not configured -- Provider UA70 (1) Cannot be Added"
	fi

	#
	# Add Provider UA67 (2)
	#
	if interface_is_usable net67; then
	    qt ip route flush table 2
	    echo "qt ip route flush table 2" >> ${VARDIR}/undo_routing
	    ip route show table main | while read net route; do
		case $net in
		    default|nexthop)
			;;
		    *)
			case $(find_device $route) in
			    net67|cln|lab|srv|trn|vpn)
				run_ip route add table 2 $net $route
				;;
			esac
			;;
		esac
	    done

	    run_ip route add default via 143.129.67.254 dev net67 table 2
	    qt ip rule del fwmark 2
	    run_ip rule add fwmark 2 pref 10001 table 2
	    echo "qt ip rule del fwmark 2" >> ${VARDIR}/undo_routing
	    
	    rulenum=0

	    find_interface_addresses net67 | while read address; do
		qt ip rule del from $address
		run_ip rule add from $address pref $(( 20256 + $rulenum )) table 2
		echo "qt ip rule del from $address" >> ${VARDIR}/undo_routing
		rulenum=$(($rulenum + 1))
	    done
	    
	    progress_message "   Provider UA67 (2) Added"

	else
	    fatal_error "Interface net67 is not configured -- Provider UA67 (2) Cannot be Added"
	fi

	#
	# We don't have any 'balance' providers so we restore any default route that we've saved
	#
	restore_default_route
	if [ -w /etc/iproute2/rt_tables ]; then
	    cat > /etc/iproute2/rt_tables <<EOF
#
# reserved values
#
255	local
254	main
253	default
0	unspec
#
# local
#
EOF

	    echocommand=$(find_echo)

	    $echocommand "1\tUA70" >>  /etc/iproute2/rt_tables
	    $echocommand "2\tUA67" >>  /etc/iproute2/rt_tables
	fi

	qt ip rule del from 0.0.0.0/0 to 143.169.0.0/16 priority 1000
	run_ip rule add from 0.0.0.0/0 to 143.169.0.0/16 priority 1000 table 254
	echo "qt ip rule del from 0.0.0.0/0 to 143.169.0.0/16 priority 1000" >> ${VARDIR}/undo_routing
	qt ip rule del from 0.0.0.0/0 to 143.129.0.0/16 priority 1000
	run_ip rule add from 0.0.0.0/0 to 143.129.0.0/16 priority 1000 table 254
	echo "qt ip rule del from 0.0.0.0/0 to 143.129.0.0/16 priority 1000" >> ${VARDIR}/undo_routing
	qt ip rule del from 0.0.0.0/0 to 146.175.0.0/16 priority 1000
	run_ip rule add from 0.0.0.0/0 to 146.175.0.0/16 priority 1000 table 254
	echo "qt ip rule del from 0.0.0.0/0 to 146.175.0.0/16 priority 1000" >> ${VARDIR}/undo_routing
	qt ip rule del from 0.0.0.0/0 to 10.0.0.0/24 priority 1000
	run_ip rule add from 0.0.0.0/0 to 10.0.0.0/24 priority 1000 table 254
	echo "qt ip rule del from 0.0.0.0/0 to 10.0.0.0/24 priority 1000" >> ${VARDIR}/undo_routing
	qt ip rule del from 143.129.80.0/24 to 0.0.0.0/0 priority 1100
	run_ip rule add from 143.129.80.0/24 to 0.0.0.0/0 priority 1100 table 2
	echo "qt ip rule del from 143.129.80.0/24 to 0.0.0.0/0 priority 1100" >> ${VARDIR}/undo_routing
	qt ip rule del from 0.0.0.0/0 to 143.129.77.32/27 priority 1000
	run_ip rule add from 0.0.0.0/0 to 143.129.77.32/27 priority 1000 table 254
	echo "qt ip rule del from 0.0.0.0/0 to 143.129.77.32/27 priority 1000" >> ${VARDIR}/undo_routing
	qt ip rule del from 143.129.77.37 to 0.0.0.0/0 priority 1100
	run_ip rule add from 143.129.77.37 to 0.0.0.0/0 priority 1100 table 2
	echo "qt ip rule del from 143.129.77.37 to 0.0.0.0/0 priority 1100" >> ${VARDIR}/undo_routing
	
	run_ip route flush cache
    fi

    del_ip_addr 143.129.80.37 net67
    cat > ${VARDIR}/proxyarp << __EOF__
__EOF__

    if [ "$COMMAND" != refresh ]; then
	cat > ${VARDIR}/chains << __EOF__
__EOF__
	cat > ${VARDIR}/zones << __EOF__
fw firewall
cln2 ipv4 net70:143.129.76.0/24
cln3 ipv4 net70:143.129.75.0/24
cln1 ipv4 cln:0.0.0.0/0
vpn ipv4 tap0:0.0.0.0/0
srv ipv4 srv:0.0.0.0/0
lab ipv4 lab:143.129.80.0/25
stsrv ipv4 lab:143.129.80.128/25
trn ipv4 trn:0.0.0.0/0
ua ipv4 net70:143.129.0.0/16,143.169.0.0/16,146.175.0.0/16
net ipv4 net67:0.0.0.0/0 net70:0.0.0.0/0
__EOF__
    fi

    > ${VARDIR}/nat
    add_ip_aliases  143.129.80.37 net67
}

setup_netfilter()
{
    
    progress_message2 Preparing iptables-restore input...

    exec 3>${VARDIR}/.iptables-restore-input

    cat >&3 << __EOF__
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:net67_in - [0:0]
:net67_out - [0:0]
:net70_masq - [0:0]
-A PREROUTING -i net67 -j net67_in
-A POSTROUTING -o net67 -j net67_out
-A POSTROUTING -o net70 -j net70_masq
-A net67_in -d 143.129.80.37  -j DNAT --to-destination 143.129.77.37
-A net67_out -s 143.129.77.37  -j SNAT --to-source 143.129.80.37
__EOF__

    for source in $TRN_NETWORKS; do
	echo "-A net70_masq -s $source -j MASQUERADE " >&3
    done

    cat >&3 << __EOF__
COMMIT
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:tcfor - [0:0]
:tcout - [0:0]
:tcpost - [0:0]
:tcpre - [0:0]
-A PREROUTING  -j tcpre
-A FORWARD -j tcfor
-A OUTPUT  -j tcout
-A POSTROUTING -j tcpost
COMMIT
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
:Drop - [0:0]
:Reject - [0:0]
:all2cln1 - [0:0]
:all2cln2 - [0:0]
:all2cln3 - [0:0]
:all2fw - [0:0]
:all2lab - [0:0]
:all2net - [0:0]
:all2srv - [0:0]
:all2stsrv - [0:0]
:all2trn - [0:0]
:all2ua - [0:0]
:all2vpn - [0:0]
:blacklog - [0:0]
:blacklst - [0:0]
:cln12cln2 - [0:0]
:cln12cln3 - [0:0]
:cln12fw - [0:0]
:cln12lab - [0:0]
:cln12net - [0:0]
:cln12srv - [0:0]
:cln12stsrv - [0:0]
:cln12trn - [0:0]
:cln12ua - [0:0]
:cln12vpn - [0:0]
:cln22cln1 - [0:0]
:cln22cln3 - [0:0]
:cln22fw - [0:0]
:cln22lab - [0:0]
:cln22net - [0:0]
:cln22srv - [0:0]
:cln22stsrv - [0:0]
:cln22trn - [0:0]
:cln22ua - [0:0]
:cln22vpn - [0:0]
:cln32cln1 - [0:0]
:cln32cln2 - [0:0]
:cln32fw - [0:0]
:cln32lab - [0:0]
:cln32net - [0:0]
:cln32srv - [0:0]
:cln32stsrv - [0:0]
:cln32trn - [0:0]
:cln32ua - [0:0]
:cln32vpn - [0:0]
:cln_fwd - [0:0]
:cln_in - [0:0]
:cln_out - [0:0]
:dropBcast - [0:0]
:dropInvalid - [0:0]
:dropNotSyn - [0:0]
:dynamic - [0:0]
:fw2cln1 - [0:0]
:fw2cln2 - [0:0]
:fw2cln3 - [0:0]
:fw2lab - [0:0]
:fw2net - [0:0]
:fw2srv - [0:0]
:fw2stsrv - [0:0]
:fw2trn - [0:0]
:fw2ua - [0:0]
:fw2vpn - [0:0]
:lab2cln1 - [0:0]
:lab2cln2 - [0:0]
:lab2cln3 - [0:0]
:lab2fw - [0:0]
:lab2net - [0:0]
:lab2srv - [0:0]
:lab2stsrv - [0:0]
:lab2trn - [0:0]
:lab2ua - [0:0]
:lab2vpn - [0:0]
:lab_fwd - [0:0]
:lab_in - [0:0]
:lab_out - [0:0]
:logdrop - [0:0]
:logflags - [0:0]
:logreject - [0:0]
:net2all - [0:0]
:net2cln1 - [0:0]
:net2cln2 - [0:0]
:net2cln3 - [0:0]
:net2fw - [0:0]
:net2lab - [0:0]
:net2srv - [0:0]
:net2stsrv - [0:0]
:net2trn - [0:0]
:net2ua - [0:0]
:net2vpn - [0:0]
:net67_fwd - [0:0]
:net67_in - [0:0]
:net67_out - [0:0]
:net70_fwd - [0:0]
:net70_in - [0:0]
:net70_out - [0:0]
:norfc1918 - [0:0]
:reject - [0:0]
:rfc1918 - [0:0]
:smurfs - [0:0]
:srv2cln1 - [0:0]
:srv2cln2 - [0:0]
:srv2cln3 - [0:0]
:srv2fw - [0:0]
:srv2lab - [0:0]
:srv2net - [0:0]
:srv2stsrv - [0:0]
:srv2trn - [0:0]
:srv2ua - [0:0]
:srv2vpn - [0:0]
:srv_fwd - [0:0]
:srv_in - [0:0]
:srv_out - [0:0]
:stsrv2cln1 - [0:0]
:stsrv2cln2 - [0:0]
:stsrv2cln3 - [0:0]
:stsrv2fw - [0:0]
:stsrv2lab - [0:0]
:stsrv2net - [0:0]
:stsrv2srv - [0:0]
:stsrv2trn - [0:0]
:stsrv2ua - [0:0]
:stsrv2vpn - [0:0]
:tap0_fwd - [0:0]
:tap0_in - [0:0]
:tap0_out - [0:0]
:tcpflags - [0:0]
:trn2cln1 - [0:0]
:trn2cln2 - [0:0]
:trn2cln3 - [0:0]
:trn2fw - [0:0]
:trn2lab - [0:0]
:trn2net - [0:0]
:trn2srv - [0:0]
:trn2stsrv - [0:0]
:trn2ua - [0:0]
:trn2vpn - [0:0]
:trn_fwd - [0:0]
:trn_in - [0:0]
:trn_out - [0:0]
:ua2all - [0:0]
:ua2cln1 - [0:0]
:ua2cln2 - [0:0]
:ua2cln3 - [0:0]
:ua2fw - [0:0]
:ua2lab - [0:0]
:ua2net - [0:0]
:ua2srv - [0:0]
:ua2stsrv - [0:0]
:ua2trn - [0:0]
:ua2vpn - [0:0]
:ua_frwd - [0:0]
:vpn2cln1 - [0:0]
:vpn2cln2 - [0:0]
:vpn2cln3 - [0:0]
:vpn2fw - [0:0]
:vpn2lab - [0:0]
:vpn2net - [0:0]
:vpn2srv - [0:0]
:vpn2stsrv - [0:0]
:vpn2trn - [0:0]
:vpn2ua - [0:0]
-A INPUT -i net70 -j net70_in
-A INPUT -i net67 -j net67_in
-A INPUT -i lab -j lab_in
-A INPUT -i cln -j cln_in
-A INPUT -i tap0 -j tap0_in
-A INPUT -i srv -j srv_in
-A INPUT -i trn -j trn_in
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -j Drop
-A INPUT -j ULOG --ulog-prefix "Shorewall:INPUT:DROP:" 
-A INPUT -j DROP
-A FORWARD -i net70 -j net70_fwd
-A FORWARD -i net67 -j net67_fwd
-A FORWARD -i lab -j lab_fwd
-A FORWARD -i cln -j cln_fwd
-A FORWARD -i tap0 -j tap0_fwd
-A FORWARD -i srv -j srv_fwd
-A FORWARD -i trn -j trn_fwd
-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -j Drop
-A FORWARD -j ULOG --ulog-prefix "Shorewall:FORWARD:DROP:" 
-A FORWARD -j DROP
-A OUTPUT -o net70 -j net70_out
-A OUTPUT -o net67 -j net67_out
-A OUTPUT -o lab -j lab_out
-A OUTPUT -o cln -j cln_out
-A OUTPUT -o tap0 -j tap0_out
-A OUTPUT -o srv -j srv_out
-A OUTPUT -o trn -j trn_out
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -j ACCEPT
-A Drop -p 6 --dport 113 -j reject
-A Drop -j dropBcast
-A Drop -p 1 --icmp-type 3/4 -j ACCEPT
-A Drop -p 1 --icmp-type 11 -j ACCEPT
-A Drop -j dropInvalid
-A Drop -p 17 -m multiport --dports 135,445 -j DROP
-A Drop -p 17 --dport 137:139 -j DROP
-A Drop -p 17 --dport 1024:65535 --sport 137 -j DROP
-A Drop -p 6 -m multiport --dports 135,139,445 -j DROP
-A Drop -p 17 --dport 1900 -j DROP
-A Drop -p 6 -j dropNotSyn
-A Drop -p 17 --sport 53 -j DROP
-A Reject -p 6 --dport 113 -j reject
-A Reject -j dropBcast
-A Reject -p 1 --icmp-type 3/4 -j ACCEPT
-A Reject -p 1 --icmp-type 11 -j ACCEPT
-A Reject -j dropInvalid
-A Reject -p 17 -m multiport --dports 135,445 -j reject
-A Reject -p 17 --dport 137:139 -j reject
-A Reject -p 17 --dport 1024:65535 --sport 137 -j reject
-A Reject -p 6 -m multiport --dports 135,139,445 -j reject
-A Reject -p 17 --dport 1900 -j DROP
-A Reject -p 6 -j dropNotSyn
-A Reject -p 17 --sport 53 -j DROP
-A all2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2cln1 -j Drop
-A all2cln1 -j ULOG --ulog-prefix "Shorewall:all2cln1:DROP:" 
-A all2cln1 -j DROP
-A all2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2cln2 -j Drop
-A all2cln2 -j ULOG --ulog-prefix "Shorewall:all2cln2:DROP:" 
-A all2cln2 -j DROP
-A all2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2cln3 -j Drop
-A all2cln3 -j ULOG --ulog-prefix "Shorewall:all2cln3:DROP:" 
-A all2cln3 -j DROP
-A all2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2fw -j Drop
-A all2fw -j ULOG --ulog-prefix "Shorewall:all2fw:DROP:" 
-A all2fw -j DROP
-A all2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2lab -j Drop
-A all2lab -j ULOG --ulog-prefix "Shorewall:all2lab:DROP:" 
-A all2lab -j DROP
-A all2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2net -j Drop
-A all2net -j ULOG --ulog-prefix "Shorewall:all2net:DROP:" 
-A all2net -j DROP
-A all2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2srv -j Drop
-A all2srv -j ULOG --ulog-prefix "Shorewall:all2srv:DROP:" 
-A all2srv -j DROP
-A all2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2stsrv -j Drop
-A all2stsrv -j ULOG --ulog-prefix "Shorewall:all2stsrv:DROP:" 
-A all2stsrv -j DROP
-A all2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2trn -j Drop
-A all2trn -j ULOG --ulog-prefix "Shorewall:all2trn:DROP:" 
-A all2trn -j DROP
-A all2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2ua -j Drop
-A all2ua -j ULOG --ulog-prefix "Shorewall:all2ua:DROP:" 
-A all2ua -j DROP
-A all2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A all2vpn -j Drop
-A all2vpn -j ULOG --ulog-prefix "Shorewall:all2vpn:DROP:" 
-A all2vpn -j DROP
-A blacklog -j ULOG --ulog-prefix "Shorewall:blacklst:DROP:" 
-A blacklog -j DROP
-A cln12cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12cln2 -p 17 --dport 5353 -j ACCEPT 
-A cln12cln2 -p 6 --dport 6881:6889 -i cln -j ACCEPT 
-A cln12cln2 -p 17 --dport 6881 -i cln -j ACCEPT 
-A cln12cln2 -p 17 --dport 53 -j ACCEPT 
-A cln12cln2 -p 6 --dport 53 -j ACCEPT 
-A cln12cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12cln3 -p 17 --dport 5353 -j ACCEPT 
-A cln12cln3 -p 6 --dport 6881:6889 -i cln -j ACCEPT 
-A cln12cln3 -p 17 --dport 6881 -i cln -j ACCEPT 
-A cln12cln3 -p 17 --dport 53 -j ACCEPT 
-A cln12cln3 -p 6 --dport 53 -j ACCEPT 
-A cln12fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12fw -p 17 --dport 5353 -j ACCEPT 
-A cln12fw -p 17 --dport 631 -j ACCEPT 
-A cln12fw -p 17 --dport 53 -j ACCEPT 
-A cln12fw -p 6 --dport 53 -j ACCEPT 
-A cln12fw -p 17 --dport 123 -j ACCEPT 
-A cln12fw -p 1 --icmp-type 8 -j ACCEPT 
-A cln12fw -p 6 --dport 22 -j ACCEPT 
-A cln12fw -i cln -s 143.129.77.37 -j ACCEPT 
-A cln12fw -i cln -s 143.129.77.35 -j ACCEPT 
-A cln12fw -i cln -s 143.129.77.34 -j ACCEPT 
-A cln12fw -j Reject
-A cln12fw -j ULOG --ulog-prefix "Shorewall:cln12fw:REJECT:" 
-A cln12fw -j reject
-A cln12lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12lab -j ACCEPT
-A cln12net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12net -j ACCEPT
-A cln12srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12srv -p 17 --dport 5353 -j ACCEPT 
-A cln12srv -p 6 --dport 6881:6889 -i cln -j ACCEPT 
-A cln12srv -p 17 --dport 6881 -i cln -j ACCEPT 
-A cln12srv -p 17 --dport 53 -j ACCEPT 
-A cln12srv -p 6 --dport 53 -j ACCEPT 
-A cln12srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 631 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 631 -d 143.129.77.2 -j ACCEPT 
-A cln12srv -p 6 --dport 9100 -d 143.129.77.2 -j ACCEPT 
-A cln12srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 3389 -d 143.129.77.5 -j ACCEPT 
-A cln12srv -p 1 --icmp-type 8 -j ACCEPT 
-A cln12srv -p 17 -m multiport --dports 135,445 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 17 --dport 137:139 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 17 --dport 1024:65535 --sport 137 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 -m multiport --dports 135,139,445 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 22 -d 143.129.77.11 -j ACCEPT 
-A cln12srv -p 6 --dport 22 -d 143.129.77.3 -j ACCEPT 
-A cln12srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:cln12srv:DROP:" 
-A cln12srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A cln12srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:cln12srv:DROP:" 
-A cln12srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A cln12srv -p 6 --dport 22 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.12 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.14 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.29 -j ACCEPT 
-A cln12srv -p 6 --dport 80 -d 143.129.77.2 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.12 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.14 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.29 -j ACCEPT 
-A cln12srv -p 6 --dport 443 -d 143.129.77.2 -j ACCEPT 
-A cln12srv -j Reject
-A cln12srv -j ULOG --ulog-prefix "Shorewall:cln12srv:REJECT:" 
-A cln12srv -j reject
-A cln12stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12stsrv -j ACCEPT
-A cln12trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12trn -p 1 --icmp-type 8 -j ACCEPT 
-A cln12trn -p 6 --dport 80 -d 10.0.0.251 -j ACCEPT 
-A cln12trn -p 6 --dport 80 -d 10.0.0.252 -j ACCEPT 
-A cln12trn -p 6 --dport 443 -d 10.0.0.251 -j ACCEPT 
-A cln12trn -p 6 --dport 443 -d 10.0.0.252 -j ACCEPT 
-A cln12trn -j ACCEPT
-A cln12ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12ua -p 17 --dport 5353 -j ACCEPT 
-A cln12ua -p 6 --dport 6881:6889 -i cln -j ACCEPT 
-A cln12ua -p 17 --dport 6881 -i cln -j ACCEPT 
-A cln12ua -p 17 --dport 53 -j ACCEPT 
-A cln12ua -p 6 --dport 53 -j ACCEPT 
-A cln12vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln12vpn -p 17 --dport 5353 -j ACCEPT 
-A cln12vpn -p 6 --dport 6881:6889 -i cln -j ACCEPT 
-A cln12vpn -p 17 --dport 6881 -i cln -j ACCEPT 
-A cln12vpn -p 17 --dport 53 -j ACCEPT 
-A cln12vpn -p 6 --dport 53 -j ACCEPT 
-A cln12vpn -j Reject
-A cln12vpn -j ULOG --ulog-prefix "Shorewall:cln12vpn:REJECT:" 
-A cln12vpn -j reject
-A cln22cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22cln1 -p 17 --dport 5353 -j ACCEPT 
-A cln22cln1 -p 6 --dport 22 -j ACCEPT 
-A cln22cln1 -p 6 --dport 80 -j ACCEPT 
-A cln22cln1 -p 6 --dport 443 -j ACCEPT 
-A cln22cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A cln22cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A cln22cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A cln22cln1 -p 17 --dport 53 -j ACCEPT 
-A cln22cln1 -p 6 --dport 53 -j ACCEPT 
-A cln22cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22cln3 -p 17 --dport 5353 -j ACCEPT 
-A cln22cln3 -p 17 --dport 53 -j ACCEPT 
-A cln22cln3 -p 6 --dport 53 -j ACCEPT 
-A cln22fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22fw -p 17 --dport 5353 -j ACCEPT 
-A cln22fw -p 17 --dport 631 -j ACCEPT 
-A cln22fw -p 17 --dport 53 -j ACCEPT 
-A cln22fw -p 6 --dport 53 -j ACCEPT 
-A cln22fw -p 17 --dport 123 -j ACCEPT 
-A cln22fw -p 1 --icmp-type 8 -j ACCEPT 
-A cln22fw -p 6 --dport 22 -j ACCEPT 
-A cln22lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22lab -j ACCEPT
-A cln22net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22net -p 17 --dport 5353 -j ACCEPT 
-A cln22net -p 17 --dport 53 -j ACCEPT 
-A cln22net -p 6 --dport 53 -j ACCEPT 
-A cln22srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22srv -p 17 --dport 5353 -j ACCEPT 
-A cln22srv -p 17 --dport 53 -j ACCEPT 
-A cln22srv -p 6 --dport 53 -j ACCEPT 
-A cln22srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 9100 -d 143.129.77.2 -j ACCEPT 
-A cln22srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 3389 -d 143.129.77.5 -j ACCEPT 
-A cln22srv -p 17 -m multiport --dports 135,445 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 17 --dport 137:139 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 17 --dport 1024:65535 --sport 137 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 -m multiport --dports 135,139,445 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 22 -d 143.129.77.11 -j ACCEPT 
-A cln22srv -p 6 --dport 22 -d 143.129.77.3 -j ACCEPT 
-A cln22srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:cln22srv:DROP:" 
-A cln22srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A cln22srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:cln22srv:DROP:" 
-A cln22srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A cln22srv -p 6 --dport 22 -j ACCEPT 
-A cln22srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A cln22srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A cln22srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A cln22srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A cln22srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A cln22srv -p 6 --dport 80 -d 143.129.77.12 -j ACCEPT 
-A cln22srv -p 6 --dport 443 -d 143.129.77.12 -j ACCEPT 
-A cln22stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22stsrv -j ACCEPT
-A cln22trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22trn -p 1 --icmp-type 8 -j ACCEPT 
-A cln22trn -p 6 --dport 80 -d 10.0.0.251 -j ACCEPT 
-A cln22trn -p 6 --dport 80 -d 10.0.0.252 -j ACCEPT 
-A cln22trn -p 6 --dport 443 -d 10.0.0.251 -j ACCEPT 
-A cln22trn -p 6 --dport 443 -d 10.0.0.252 -j ACCEPT 
-A cln22trn -j ACCEPT
-A cln22ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22ua -p 17 --dport 5353 -j ACCEPT 
-A cln22ua -p 17 --dport 53 -j ACCEPT 
-A cln22ua -p 6 --dport 53 -j ACCEPT 
-A cln22vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln22vpn -p 17 --dport 5353 -j ACCEPT 
-A cln22vpn -p 17 --dport 53 -j ACCEPT 
-A cln22vpn -p 6 --dport 53 -j ACCEPT 
-A cln32cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32cln1 -p 17 --dport 5353 -j ACCEPT 
-A cln32cln1 -p 6 --dport 22 -j ACCEPT 
-A cln32cln1 -p 6 --dport 80 -j ACCEPT 
-A cln32cln1 -p 6 --dport 443 -j ACCEPT 
-A cln32cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A cln32cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A cln32cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A cln32cln1 -p 17 --dport 53 -j ACCEPT 
-A cln32cln1 -p 6 --dport 53 -j ACCEPT 
-A cln32cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32cln2 -p 17 --dport 5353 -j ACCEPT 
-A cln32cln2 -p 17 --dport 53 -j ACCEPT 
-A cln32cln2 -p 6 --dport 53 -j ACCEPT 
-A cln32fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32fw -p 17 --dport 5353 -j ACCEPT 
-A cln32fw -p 17 --dport 53 -j ACCEPT 
-A cln32fw -p 6 --dport 53 -j ACCEPT 
-A cln32fw -p 17 --dport 123 -j ACCEPT 
-A cln32fw -p 6 --dport 22 -j ACCEPT 
-A cln32lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32lab -p 17 --dport 5353 -j ACCEPT 
-A cln32lab -p 17 --dport 53 -j ACCEPT 
-A cln32lab -p 6 --dport 53 -j ACCEPT 
-A cln32lab -p 6 --dport 22 -o lab -j ACCEPT 
-A cln32net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32net -p 17 --dport 5353 -j ACCEPT 
-A cln32net -p 17 --dport 53 -j ACCEPT 
-A cln32net -p 6 --dport 53 -j ACCEPT 
-A cln32srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32srv -p 17 --dport 5353 -j ACCEPT 
-A cln32srv -p 17 --dport 53 -j ACCEPT 
-A cln32srv -p 6 --dport 53 -j ACCEPT 
-A cln32srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 --dport 3389 -d 143.129.77.5 -j ACCEPT 
-A cln32srv -p 17 -m multiport --dports 135,445 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 17 --dport 137:139 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 17 --dport 1024:65535 --sport 137 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 -m multiport --dports 135,139,445 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 --dport 22 -d 143.129.77.11 -j ACCEPT 
-A cln32srv -p 6 --dport 22 -d 143.129.77.3 -j ACCEPT 
-A cln32srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:cln32srv:DROP:" 
-A cln32srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A cln32srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:cln32srv:DROP:" 
-A cln32srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A cln32srv -p 6 --dport 22 -j ACCEPT 
-A cln32srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A cln32srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A cln32srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A cln32srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A cln32srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A cln32srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A cln32stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32stsrv -p 17 --dport 5353 -j ACCEPT 
-A cln32stsrv -p 17 --dport 53 -j ACCEPT 
-A cln32stsrv -p 6 --dport 53 -j ACCEPT 
-A cln32stsrv -p 6 --dport 22 -o lab -j ACCEPT 
-A cln32stsrv -p 6 --dport 80 -o lab -j ACCEPT 
-A cln32stsrv -p 6 --dport 443 -o lab -j ACCEPT 
-A cln32trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32trn -p 17 --dport 5353 -j ACCEPT 
-A cln32trn -p 17 --dport 53 -j ACCEPT 
-A cln32trn -p 6 --dport 53 -j ACCEPT 
-A cln32ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32ua -p 17 --dport 5353 -j ACCEPT 
-A cln32ua -p 17 --dport 53 -j ACCEPT 
-A cln32ua -p 6 --dport 53 -j ACCEPT 
-A cln32vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A cln32vpn -p 17 --dport 5353 -j ACCEPT 
-A cln32vpn -p 17 --dport 53 -j ACCEPT 
-A cln32vpn -p 6 --dport 53 -j ACCEPT 
-A cln_fwd  -j dynamic
-A cln_fwd -m state --state NEW,INVALID -j smurfs
-A cln_fwd -p tcp -j tcpflags
-A cln_fwd -o net70 -d 143.129.76.0/24 -j cln12cln2
-A cln_fwd -o net70 -d 143.129.75.0/24 -j cln12cln3
-A cln_fwd -o tap0 -j cln12vpn
-A cln_fwd -o srv -j cln12srv
-A cln_fwd -o lab -d 143.129.80.0/25 -j cln12lab
-A cln_fwd -o lab -d 143.129.80.128/25 -j cln12stsrv
-A cln_fwd -o trn -j cln12trn
-A cln_fwd -o net70 -d 143.129.0.0/16 -j cln12ua
-A cln_fwd -o net70 -d 143.169.0.0/16 -j cln12ua
-A cln_fwd -o net70 -d 146.175.0.0/16 -j cln12ua
-A cln_fwd -o net70 -j cln12net
-A cln_fwd -o net67 -j cln12net
-A cln_in  -j dynamic
-A cln_in -m state --state NEW,INVALID -j smurfs
-A cln_in -p udp --dport 67:68 -j ACCEPT
-A cln_in -p tcp -j tcpflags
-A cln_in -j cln12fw
-A cln_out -p udp --dport 67:68 -j ACCEPT
-A cln_out -j fw2cln1
-A dropBcast -m addrtype --dst-type BROADCAST -j DROP
-A dropBcast -d 224.0.0.0/4 -j DROP
-A dropInvalid -m state --state INVALID -j DROP
-A dropNotSyn -p tcp ! --syn -j DROP
-A fw2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2cln1 -p 6 --dport 631 -j ACCEPT 
-A fw2cln1 -j ACCEPT
-A fw2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2cln2 -p 17 --dport 5353 -j ACCEPT 
-A fw2cln2 -p 6 --dport 631 -j ACCEPT 
-A fw2cln2 -p 17 --dport 53 -j ACCEPT 
-A fw2cln2 -p 6 --dport 53 -j ACCEPT 
-A fw2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2cln3 -p 17 --dport 5353 -j ACCEPT 
-A fw2cln3 -p 17 --dport 53 -j ACCEPT 
-A fw2cln3 -p 6 --dport 53 -j ACCEPT 
-A fw2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2lab -j ACCEPT
-A fw2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2net -p udp  --sport 1194 -j ACCEPT
-A fw2net -j ACCEPT
-A fw2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2srv -p 6 --dport 631 -d 143.129.77.9 -j ACCEPT 
-A fw2srv -p 6 --dport 631 -d 143.129.77.2 -j ACCEPT 
-A fw2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:fw2srv:DROP:" 
-A fw2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A fw2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:fw2srv:DROP:" 
-A fw2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A fw2srv -p 6 --dport 10051 -d 143.129.77.9 -j ACCEPT 
-A fw2srv -j ACCEPT
-A fw2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2stsrv -j ACCEPT
-A fw2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2trn -j ACCEPT
-A fw2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2ua -p 17 --dport 5353 -j ACCEPT 
-A fw2ua -p 17 --dport 53 -j ACCEPT 
-A fw2ua -p 6 --dport 53 -j ACCEPT 
-A fw2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A fw2vpn -p 6 --dport 631 -j ACCEPT 
-A fw2vpn -j ACCEPT
-A lab2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2cln1 -p 17 --dport 5353 -j ACCEPT 
-A lab2cln1 -p 6 --dport 22 -j ACCEPT 
-A lab2cln1 -p 6 --dport 80 -j ACCEPT 
-A lab2cln1 -p 6 --dport 443 -j ACCEPT 
-A lab2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A lab2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A lab2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A lab2cln1 -p 17 --dport 53 -j ACCEPT 
-A lab2cln1 -p 6 --dport 53 -j ACCEPT 
-A lab2cln1 -j Reject
-A lab2cln1 -j ULOG --ulog-prefix "Shorewall:lab2cln1:REJECT:" 
-A lab2cln1 -j reject
-A lab2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2cln2 -p 17 --dport 5353 -j ACCEPT 
-A lab2cln2 -p 17 --dport 53 -j ACCEPT 
-A lab2cln2 -p 6 --dport 53 -j ACCEPT 
-A lab2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2cln3 -p 17 --dport 5353 -j ACCEPT 
-A lab2cln3 -p 17 --dport 53 -j ACCEPT 
-A lab2cln3 -p 6 --dport 53 -j ACCEPT 
-A lab2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2fw -p 17 --dport 5353 -j ACCEPT 
-A lab2fw -p 17 --dport 53 -j ACCEPT 
-A lab2fw -p 6 --dport 53 -j ACCEPT 
-A lab2fw -p 17 --dport 123 -j ACCEPT 
-A lab2fw -p 6 --dport 22 -j ACCEPT 
-A lab2fw -j Reject
-A lab2fw -j ULOG --ulog-prefix "Shorewall:lab2fw:REJECT:" 
-A lab2fw -j reject
-A lab2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2net -j ACCEPT
-A lab2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2srv -p 17 --dport 5353 -j ACCEPT 
-A lab2srv -p 17 --dport 53 -j ACCEPT 
-A lab2srv -p 6 --dport 53 -j ACCEPT 
-A lab2srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:lab2srv:DROP:" 
-A lab2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A lab2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:lab2srv:DROP:" 
-A lab2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A lab2srv -p 6 --dport 22 -j ACCEPT 
-A lab2srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A lab2srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A lab2srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A lab2srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A lab2srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A lab2srv -j Reject
-A lab2srv -j ULOG --ulog-prefix "Shorewall:lab2srv:REJECT:" 
-A lab2srv -j reject
-A lab2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2stsrv -p 17 --dport 5353 -j ACCEPT 
-A lab2stsrv -p 17 --dport 53 -j ACCEPT 
-A lab2stsrv -p 6 --dport 53 -j ACCEPT 
-A lab2stsrv -p 6 --dport 22 -o lab -j ACCEPT 
-A lab2stsrv -p 6 --dport 80 -o lab -j ACCEPT 
-A lab2stsrv -p 6 --dport 443 -o lab -j ACCEPT 
-A lab2stsrv -j Reject
-A lab2stsrv -j ULOG --ulog-prefix "Shorewall:lab2stsrv:REJECT:" 
-A lab2stsrv -j reject
-A lab2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2trn -p 17 --dport 5353 -j ACCEPT 
-A lab2trn -p 17 --dport 53 -j ACCEPT 
-A lab2trn -p 6 --dport 53 -j ACCEPT 
-A lab2trn -p 17 -m multiport --dports 135,445 -i lab -d 10.0.0.253 -j ACCEPT 
-A lab2trn -p 17 --dport 137:139 -i lab -d 10.0.0.253 -j ACCEPT 
-A lab2trn -p 17 --dport 1024:65535 --sport 137 -i lab -d 10.0.0.253 -j ACCEPT 
-A lab2trn -p 6 -m multiport --dports 135,139,445 -i lab -d 10.0.0.253 -j ACCEPT 
-A lab2trn -p 6 --dport 873 -i lab -d 10.0.0.253 -j ACCEPT 
-A lab2trn -j Reject
-A lab2trn -j ULOG --ulog-prefix "Shorewall:lab2trn:REJECT:" 
-A lab2trn -j reject
-A lab2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2ua -p 17 --dport 5353 -j ACCEPT 
-A lab2ua -p 17 --dport 53 -j ACCEPT 
-A lab2ua -p 6 --dport 53 -j ACCEPT 
-A lab2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A lab2vpn -p 17 --dport 5353 -j ACCEPT 
-A lab2vpn -p 17 --dport 53 -j ACCEPT 
-A lab2vpn -p 6 --dport 53 -j ACCEPT 
-A lab2vpn -j Reject
-A lab2vpn -j ULOG --ulog-prefix "Shorewall:lab2vpn:REJECT:" 
-A lab2vpn -j reject
-A lab_fwd  -j dynamic
-A lab_fwd -j blacklst
-A lab_fwd -m state --state NEW,INVALID -j smurfs
-A lab_fwd -p tcp -j tcpflags
-A lab_fwd -o net70 -s 143.129.80.0/25 -d 143.129.76.0/24 -j lab2cln2
-A lab_fwd -o net70 -s 143.129.80.0/25 -d 143.129.75.0/24 -j lab2cln3
-A lab_fwd -o cln -s 143.129.80.0/25 -j lab2cln1
-A lab_fwd -o tap0 -s 143.129.80.0/25 -j lab2vpn
-A lab_fwd -o srv -s 143.129.80.0/25 -j lab2srv
-A lab_fwd -o lab -s 143.129.80.0/25 -d 143.129.80.128/25 -j lab2stsrv
-A lab_fwd -o trn -s 143.129.80.0/25 -j lab2trn
-A lab_fwd -o net70 -s 143.129.80.0/25 -d 143.129.0.0/16 -j lab2ua
-A lab_fwd -o net70 -s 143.129.80.0/25 -d 143.169.0.0/16 -j lab2ua
-A lab_fwd -o net70 -s 143.129.80.0/25 -d 146.175.0.0/16 -j lab2ua
-A lab_fwd -o net70 -s 143.129.80.0/25 -j lab2net
-A lab_fwd -o net67 -s 143.129.80.0/25 -j lab2net
-A lab_fwd -o net70 -s 143.129.80.128/25 -d 143.129.76.0/24 -j stsrv2cln2
-A lab_fwd -o net70 -s 143.129.80.128/25 -d 143.129.75.0/24 -j stsrv2cln3
-A lab_fwd -o cln -s 143.129.80.128/25 -j stsrv2cln1
-A lab_fwd -o tap0 -s 143.129.80.128/25 -j stsrv2vpn
-A lab_fwd -o srv -s 143.129.80.128/25 -j stsrv2srv
-A lab_fwd -o lab -s 143.129.80.128/25 -d 143.129.80.0/25 -j stsrv2lab
-A lab_fwd -o trn -s 143.129.80.128/25 -j stsrv2trn
-A lab_fwd -o net70 -s 143.129.80.128/25 -d 143.129.0.0/16 -j stsrv2ua
-A lab_fwd -o net70 -s 143.129.80.128/25 -d 143.169.0.0/16 -j stsrv2ua
-A lab_fwd -o net70 -s 143.129.80.128/25 -d 146.175.0.0/16 -j stsrv2ua
-A lab_fwd -o net70 -s 143.129.80.128/25 -j stsrv2net
-A lab_fwd -o net67 -s 143.129.80.128/25 -j stsrv2net
-A lab_in  -j dynamic
-A lab_in -j blacklst
-A lab_in -m state --state NEW,INVALID -j smurfs
-A lab_in -p udp --dport 67:68 -j ACCEPT
-A lab_in -p tcp -j tcpflags
-A lab_in -s 143.129.80.0/25 -j lab2fw
-A lab_in -s 143.129.80.128/25 -j stsrv2fw
-A lab_out -p udp --dport 67:68 -j ACCEPT
-A lab_out -d 143.129.80.0/25 -j fw2lab
-A lab_out -d 143.129.80.128/25 -j fw2stsrv
-A logdrop  -j ULOG --ulog-prefix "Shorewall:logdrop:DROP:" 
-A logdrop  -j DROP
-A logflags -j ULOG --ulog-prefix "Shorewall:logflags:DROP:" 
-A logflags -j DROP
-A logreject  -j ULOG --ulog-prefix "Shorewall:logreject:REJECT:" 
-A logreject  -j reject
-A net2all -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2all -j Drop
-A net2all -j ULOG --ulog-prefix "Shorewall:net2all:DROP:" 
-A net2all -j DROP
-A net2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2cln1 -p 17 --dport 5353 -j ACCEPT 
-A net2cln1 -p 6 --dport 22 -j ACCEPT 
-A net2cln1 -p 6 --dport 80 -j ACCEPT 
-A net2cln1 -p 6 --dport 443 -j ACCEPT 
-A net2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A net2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A net2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A net2cln1 -p 17 --dport 53 -j ACCEPT 
-A net2cln1 -p 6 --dport 53 -j ACCEPT 
-A net2cln1 -j Drop
-A net2cln1 -j ULOG --ulog-prefix "Shorewall:net2cln1:DROP:" 
-A net2cln1 -j DROP
-A net2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2cln2 -p 17 --dport 5353 -j ACCEPT 
-A net2cln2 -p 17 --dport 53 -j ACCEPT 
-A net2cln2 -p 6 --dport 53 -j ACCEPT 
-A net2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2cln3 -p 17 --dport 5353 -j ACCEPT 
-A net2cln3 -p 17 --dport 53 -j ACCEPT 
-A net2cln3 -p 6 --dport 53 -j ACCEPT 
-A net2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2fw -p 17 --dport 5353 -j ACCEPT 
-A net2fw -p 17 --dport 53 -j ACCEPT 
-A net2fw -p 6 --dport 53 -j ACCEPT 
-A net2fw -p 17 --dport 123 -j ACCEPT 
-A net2fw -p 1 --icmp-type 8 -i net70 -s 143.129.254.99 -j ACCEPT 
-A net2fw -p 1 --icmp-type 8 -i net70 -s 143.169.254.99 -j ACCEPT 
-A net2fw -p 6 --dport 22 -j ACCEPT 
-A net2fw -p udp  --dport 1194 -j ACCEPT
-A net2fw -j Drop
-A net2fw -j ULOG --ulog-prefix "Shorewall:net2fw:DROP:" 
-A net2fw -j DROP
-A net2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2lab -p 17 --dport 5353 -j ACCEPT 
-A net2lab -p 17 --dport 53 -j ACCEPT 
-A net2lab -p 6 --dport 53 -j ACCEPT 
-A net2lab -p 6 --dport 22 -o lab -j ACCEPT 
-A net2lab -j Drop
-A net2lab -j ULOG --ulog-prefix "Shorewall:net2lab:DROP:" 
-A net2lab -j DROP
-A net2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2srv -p 17 --dport 5353 -j ACCEPT 
-A net2srv -p 17 --dport 53 -j ACCEPT 
-A net2srv -p 6 --dport 53 -j ACCEPT 
-A net2srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A net2srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A net2srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A net2srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A net2srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A net2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:net2srv:DROP:" 
-A net2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A net2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:net2srv:DROP:" 
-A net2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A net2srv -p 6 --dport 22 -j ACCEPT 
-A net2srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A net2srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A net2srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A net2srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A net2srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A net2srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A net2srv -j Drop
-A net2srv -j ULOG --ulog-prefix "Shorewall:net2srv:DROP:" 
-A net2srv -j DROP
-A net2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2stsrv -p 17 --dport 5353 -j ACCEPT 
-A net2stsrv -p 17 --dport 53 -j ACCEPT 
-A net2stsrv -p 6 --dport 53 -j ACCEPT 
-A net2stsrv -p 6 --dport 22 -o lab -j ACCEPT 
-A net2stsrv -p 6 --dport 80 -o lab -j ACCEPT 
-A net2stsrv -p 6 --dport 443 -o lab -j ACCEPT 
-A net2stsrv -j Drop
-A net2stsrv -j ULOG --ulog-prefix "Shorewall:net2stsrv:DROP:" 
-A net2stsrv -j DROP
-A net2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2trn -p 17 --dport 5353 -j ACCEPT 
-A net2trn -p 17 --dport 53 -j ACCEPT 
-A net2trn -p 6 --dport 53 -j ACCEPT 
-A net2trn -j Drop
-A net2trn -j ULOG --ulog-prefix "Shorewall:net2trn:DROP:" 
-A net2trn -j DROP
-A net2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2ua -p 17 --dport 5353 -j ACCEPT 
-A net2ua -p 17 --dport 53 -j ACCEPT 
-A net2ua -p 6 --dport 53 -j ACCEPT 
-A net2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A net2vpn -p 17 --dport 5353 -j ACCEPT 
-A net2vpn -p 17 --dport 53 -j ACCEPT 
-A net2vpn -p 6 --dport 53 -j ACCEPT 
-A net2vpn -j Drop
-A net2vpn -j ULOG --ulog-prefix "Shorewall:net2vpn:DROP:" 
-A net2vpn -j DROP
-A net67_fwd  -j dynamic
-A net67_fwd -j blacklst
-A net67_fwd -m state --state NEW,INVALID -j smurfs
-A net67_fwd -p tcp -j tcpflags
-A net67_fwd -o net70 -d 143.129.76.0/24 -j net2cln2
-A net67_fwd -o net70 -d 143.129.75.0/24 -j net2cln3
-A net67_fwd -o cln -j net2cln1
-A net67_fwd -o tap0 -j net2vpn
-A net67_fwd -o srv -j net2srv
-A net67_fwd -o lab -d 143.129.80.0/25 -j net2lab
-A net67_fwd -o lab -d 143.129.80.128/25 -j net2stsrv
-A net67_fwd -o trn -j net2trn
-A net67_fwd -o net70 -d 143.129.0.0/16 -j net2ua
-A net67_fwd -o net70 -d 143.169.0.0/16 -j net2ua
-A net67_fwd -o net70 -d 146.175.0.0/16 -j net2ua
-A net67_fwd -o net70 -j ACCEPT
-A net67_in  -j dynamic
-A net67_in -j blacklst
-A net67_in -m state --state NEW,INVALID -j smurfs
-A net67_in -p tcp -j tcpflags
-A net67_in -j net2fw
-A net67_out -j fw2net
-A net70_fwd  -j dynamic
-A net70_fwd -j blacklst
-A net70_fwd -m state --state NEW,INVALID -j smurfs
-A net70_fwd -m state --state NEW -j norfc1918
-A net70_fwd -p tcp -j tcpflags
-A net70_fwd -o net70 -s 143.129.76.0/24 -d 143.129.75.0/24 -j cln22cln3
-A net70_fwd -o cln -s 143.129.76.0/24 -j cln22cln1
-A net70_fwd -o tap0 -s 143.129.76.0/24 -j cln22vpn
-A net70_fwd -o srv -s 143.129.76.0/24 -j cln22srv
-A net70_fwd -o lab -s 143.129.76.0/24 -d 143.129.80.0/25 -j cln22lab
-A net70_fwd -o lab -s 143.129.76.0/24 -d 143.129.80.128/25 -j cln22stsrv
-A net70_fwd -o trn -s 143.129.76.0/24 -j cln22trn
-A net70_fwd -o net70 -s 143.129.76.0/24 -d 143.129.0.0/16 -j cln22ua
-A net70_fwd -o net70 -s 143.129.76.0/24 -d 143.169.0.0/16 -j cln22ua
-A net70_fwd -o net70 -s 143.129.76.0/24 -d 146.175.0.0/16 -j cln22ua
-A net70_fwd -o net70 -s 143.129.76.0/24 -j cln22net
-A net70_fwd -o net67 -s 143.129.76.0/24 -j cln22net
-A net70_fwd -o net70 -s 143.129.75.0/24 -d 143.129.76.0/24 -j cln32cln2
-A net70_fwd -o cln -s 143.129.75.0/24 -j cln32cln1
-A net70_fwd -o tap0 -s 143.129.75.0/24 -j cln32vpn
-A net70_fwd -o srv -s 143.129.75.0/24 -j cln32srv
-A net70_fwd -o lab -s 143.129.75.0/24 -d 143.129.80.0/25 -j cln32lab
-A net70_fwd -o lab -s 143.129.75.0/24 -d 143.129.80.128/25 -j cln32stsrv
-A net70_fwd -o trn -s 143.129.75.0/24 -j cln32trn
-A net70_fwd -o net70 -s 143.129.75.0/24 -d 143.129.0.0/16 -j cln32ua
-A net70_fwd -o net70 -s 143.129.75.0/24 -d 143.169.0.0/16 -j cln32ua
-A net70_fwd -o net70 -s 143.129.75.0/24 -d 146.175.0.0/16 -j cln32ua
-A net70_fwd -o net70 -s 143.129.75.0/24 -j cln32net
-A net70_fwd -o net67 -s 143.129.75.0/24 -j cln32net
-A net70_fwd -s 143.129.0.0/16 -j ua_frwd
-A net70_fwd -s 143.169.0.0/16 -j ua_frwd
-A net70_fwd -s 146.175.0.0/16 -j ua_frwd
-A net70_fwd -o net70 -d 143.129.76.0/24 -j net2cln2
-A net70_fwd -o net70 -d 143.129.75.0/24 -j net2cln3
-A net70_fwd -o cln -j net2cln1
-A net70_fwd -o tap0 -j net2vpn
-A net70_fwd -o srv -j net2srv
-A net70_fwd -o lab -d 143.129.80.0/25 -j net2lab
-A net70_fwd -o lab -d 143.129.80.128/25 -j net2stsrv
-A net70_fwd -o trn -j net2trn
-A net70_fwd -o net70 -d 143.129.0.0/16 -j net2ua
-A net70_fwd -o net70 -d 143.169.0.0/16 -j net2ua
-A net70_fwd -o net70 -d 146.175.0.0/16 -j net2ua
-A net70_fwd -o net67 -j ACCEPT
-A net70_in  -j dynamic
-A net70_in -j blacklst
-A net70_in -m state --state NEW,INVALID -j smurfs
-A net70_in -m state --state NEW -j norfc1918
-A net70_in -p tcp -j tcpflags
-A net70_in -s 143.129.76.0/24 -j cln22fw
-A net70_in -s 143.129.75.0/24 -j cln32fw
-A net70_in -s 143.129.0.0/16 -j ua2fw
-A net70_in -s 143.169.0.0/16 -j ua2fw
-A net70_in -s 146.175.0.0/16 -j ua2fw
-A net70_in -j net2fw
-A net70_out -d 143.129.76.0/24 -j fw2cln2
-A net70_out -d 143.129.75.0/24 -j fw2cln3
-A net70_out -d 143.129.0.0/16 -j fw2ua
-A net70_out -d 143.169.0.0/16 -j fw2ua
-A net70_out -d 146.175.0.0/16 -j fw2ua
-A net70_out -j fw2net
-A norfc1918 -s 172.16.0.0/12 -j rfc1918
-A norfc1918 -m conntrack --ctorigdst 172.16.0.0/12 -j rfc1918
-A norfc1918 -s 192.168.0.0/16 -j rfc1918
-A norfc1918 -m conntrack --ctorigdst 192.168.0.0/16 -j rfc1918
-A norfc1918 -s 10.0.0.0/8 -j rfc1918
-A norfc1918 -m conntrack --ctorigdst 10.0.0.0/8 -j rfc1918
-A reject -m addrtype --src-type BROADCAST -j DROP
-A reject -s 224.0.0.0/4 -j DROP
-A reject -p 2 -j DROP
-A reject -p 6 -j REJECT --reject-with tcp-reset
-A reject -p 17 -j REJECT
-A reject -p 1 -j REJECT --reject-with icmp-host-unreachable
-A reject -j REJECT --reject-with icmp-host-prohibited
-A rfc1918 -j ULOG --ulog-prefix "Shorewall:rfc1918:DROP:" 
-A rfc1918 -j DROP
-A smurfs -s 0.0.0.0 -j RETURN
-A smurfs -m addrtype --src-type BROADCAST -j ULOG --ulog-prefix "Shorewall:smurfs:DROP:" 
-A smurfs -m addrtype --src-type BROADCAST -j DROP
-A smurfs -s 224.0.0.0/4 -j ULOG --ulog-prefix "Shorewall:smurfs:DROP:" 
-A smurfs -s 224.0.0.0/4 -j DROP
-A srv2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2cln1 -p 17 --dport 5353 -j ACCEPT 
-A srv2cln1 -p 6 --dport 22 -j ACCEPT 
-A srv2cln1 -p 6 --dport 80 -j ACCEPT 
-A srv2cln1 -p 6 --dport 443 -j ACCEPT 
-A srv2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A srv2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A srv2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A srv2cln1 -p 17 --dport 53 -j ACCEPT 
-A srv2cln1 -p 6 --dport 53 -j ACCEPT 
-A srv2cln1 -j Reject
-A srv2cln1 -j ULOG --ulog-prefix "Shorewall:srv2cln1:REJECT:" 
-A srv2cln1 -j reject
-A srv2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2cln2 -p 17 --dport 5353 -j ACCEPT 
-A srv2cln2 -p 17 --dport 53 -j ACCEPT 
-A srv2cln2 -p 6 --dport 53 -j ACCEPT 
-A srv2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2cln3 -p 17 --dport 5353 -j ACCEPT 
-A srv2cln3 -p 17 --dport 53 -j ACCEPT 
-A srv2cln3 -p 6 --dport 53 -j ACCEPT 
-A srv2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2fw -p 17 --dport 5353 -j ACCEPT 
-A srv2fw -p 17 --dport 53 -j ACCEPT 
-A srv2fw -p 6 --dport 53 -j ACCEPT 
-A srv2fw -p 17 --dport 123 -j ACCEPT 
-A srv2fw -p 1 --icmp-type 8 -j ACCEPT 
-A srv2fw -p 17 --dport 161:162 -s 143.129.77.9 -j ACCEPT 
-A srv2fw -p 6 --dport 161 -s 143.129.77.9 -j ACCEPT 
-A srv2fw -p 6 --dport 22 -j ACCEPT 
-A srv2fw -p 17 --dport 631 -s 143.129.77.9 -j ACCEPT 
-A srv2fw -p 17 --dport 631 -s 143.129.77.2 -j ACCEPT 
-A srv2fw -p 6 --dport 10050 -s 143.129.77.9 -j ACCEPT 
-A srv2fw -j Reject
-A srv2fw -j ULOG --ulog-prefix "Shorewall:srv2fw:REJECT:" 
-A srv2fw -j reject
-A srv2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2lab -p 17 --dport 161:162 -s 143.129.77.9 -d 143.129.80.253 -j ACCEPT 
-A srv2lab -p 6 --dport 161 -s 143.129.77.9 -d 143.129.80.253 -j ACCEPT 
-A srv2lab -j ACCEPT
-A srv2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2net -j ACCEPT
-A srv2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2stsrv -p 6 --dport 10050 -o lab -s 143.129.77.9 -d 143.129.80.253 -j ACCEPT 
-A srv2stsrv -j ACCEPT
-A srv2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2trn -p 17 --dport 5353 -j ACCEPT 
-A srv2trn -p 17 --dport 53 -j ACCEPT 
-A srv2trn -p 6 --dport 53 -j ACCEPT 
-A srv2trn -p 6 --dport 10050 -s 143.129.77.9 -d 10.0.0.253 -j ACCEPT 
-A srv2trn -p 1 --icmp-type 8 -j ACCEPT 
-A srv2trn -p 17 --dport 161:162 -s 143.129.77.9 -d 10.0.0.253 -j ACCEPT 
-A srv2trn -p 6 --dport 161 -s 143.129.77.9 -d 10.0.0.253 -j ACCEPT 
-A srv2trn -p 6 --dport 22 -j ACCEPT 
-A srv2trn -j Reject
-A srv2trn -j ULOG --ulog-prefix "Shorewall:srv2trn:REJECT:" 
-A srv2trn -j reject
-A srv2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2ua -p 17 --dport 5353 -j ACCEPT 
-A srv2ua -p 17 --dport 53 -j ACCEPT 
-A srv2ua -p 6 --dport 53 -j ACCEPT 
-A srv2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A srv2vpn -p 17 --dport 5353 -j ACCEPT 
-A srv2vpn -p 17 --dport 53 -j ACCEPT 
-A srv2vpn -p 6 --dport 53 -j ACCEPT 
-A srv2vpn -j Reject
-A srv2vpn -j ULOG --ulog-prefix "Shorewall:srv2vpn:REJECT:" 
-A srv2vpn -j reject
-A srv_fwd  -j dynamic
-A srv_fwd -m state --state NEW,INVALID -j smurfs
-A srv_fwd -p tcp -j tcpflags
-A srv_fwd -o net70 -d 143.129.76.0/24 -j srv2cln2
-A srv_fwd -o net70 -d 143.129.75.0/24 -j srv2cln3
-A srv_fwd -o cln -j srv2cln1
-A srv_fwd -o tap0 -j srv2vpn
-A srv_fwd -o lab -d 143.129.80.0/25 -j srv2lab
-A srv_fwd -o lab -d 143.129.80.128/25 -j srv2stsrv
-A srv_fwd -o trn -j srv2trn
-A srv_fwd -o net70 -d 143.129.0.0/16 -j srv2ua
-A srv_fwd -o net70 -d 143.169.0.0/16 -j srv2ua
-A srv_fwd -o net70 -d 146.175.0.0/16 -j srv2ua
-A srv_fwd -o net70 -j srv2net
-A srv_fwd -o net67 -j srv2net
-A srv_in  -j dynamic
-A srv_in -m state --state NEW,INVALID -j smurfs
-A srv_in -p udp --dport 67:68 -j ACCEPT
-A srv_in -p tcp -j tcpflags
-A srv_in -j srv2fw
-A srv_out -p udp --dport 67:68 -j ACCEPT
-A srv_out -j fw2srv
-A stsrv2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2cln1 -p 17 --dport 5353 -j ACCEPT 
-A stsrv2cln1 -p 6 --dport 22 -j ACCEPT 
-A stsrv2cln1 -p 6 --dport 80 -j ACCEPT 
-A stsrv2cln1 -p 6 --dport 443 -j ACCEPT 
-A stsrv2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A stsrv2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A stsrv2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A stsrv2cln1 -p 17 --dport 53 -j ACCEPT 
-A stsrv2cln1 -p 6 --dport 53 -j ACCEPT 
-A stsrv2cln1 -j Reject
-A stsrv2cln1 -j ULOG --ulog-prefix "Shorewall:stsrv2cln1:REJECT:" 
-A stsrv2cln1 -j reject
-A stsrv2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2cln2 -p 17 --dport 5353 -j ACCEPT 
-A stsrv2cln2 -p 17 --dport 53 -j ACCEPT 
-A stsrv2cln2 -p 6 --dport 53 -j ACCEPT 
-A stsrv2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2cln3 -p 17 --dport 5353 -j ACCEPT 
-A stsrv2cln3 -p 17 --dport 53 -j ACCEPT 
-A stsrv2cln3 -p 6 --dport 53 -j ACCEPT 
-A stsrv2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2fw -p 17 --dport 5353 -j ACCEPT 
-A stsrv2fw -p 17 --dport 53 -j ACCEPT 
-A stsrv2fw -p 6 --dport 53 -j ACCEPT 
-A stsrv2fw -p 17 --dport 123 -j ACCEPT 
-A stsrv2fw -p 6 --dport 22 -j ACCEPT 
-A stsrv2fw -j Reject
-A stsrv2fw -j ULOG --ulog-prefix "Shorewall:stsrv2fw:REJECT:" 
-A stsrv2fw -j reject
-A stsrv2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2lab -p 17 --dport 5353 -j ACCEPT 
-A stsrv2lab -p 17 --dport 53 -j ACCEPT 
-A stsrv2lab -p 6 --dport 53 -j ACCEPT 
-A stsrv2lab -p 6 --dport 22 -o lab -j ACCEPT 
-A stsrv2lab -j Reject
-A stsrv2lab -j ULOG --ulog-prefix "Shorewall:stsrv2lab:REJECT:" 
-A stsrv2lab -j reject
-A stsrv2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2net -i lab -s 143.129.80.253 -j ACCEPT 
-A stsrv2net -j ACCEPT
-A stsrv2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2srv -p 17 --dport 5353 -j ACCEPT 
-A stsrv2srv -p 17 --dport 53 -j ACCEPT 
-A stsrv2srv -p 6 --dport 53 -j ACCEPT 
-A stsrv2srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:stsrv2srv:DROP:" 
-A stsrv2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A stsrv2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:stsrv2srv:DROP:" 
-A stsrv2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A stsrv2srv -p 6 --dport 22 -j ACCEPT 
-A stsrv2srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A stsrv2srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A stsrv2srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A stsrv2srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A stsrv2srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -p 6 --dport 80 -i lab -s 143.129.80.253 -d 143.129.77.14 -j ACCEPT 
-A stsrv2srv -p 6 --dport 443 -i lab -s 143.129.80.253 -d 143.129.77.14 -j ACCEPT 
-A stsrv2srv -p 6 --dport 5000 -i lab -s 143.129.80.253 -d 143.129.77.14 -j ACCEPT 
-A stsrv2srv -p 6 --dport 10051 -i lab -s 143.129.80.253 -d 143.129.77.9 -j ACCEPT 
-A stsrv2srv -j Reject
-A stsrv2srv -j ULOG --ulog-prefix "Shorewall:stsrv2srv:REJECT:" 
-A stsrv2srv -j reject
-A stsrv2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2trn -p 17 --dport 5353 -j ACCEPT 
-A stsrv2trn -p 17 --dport 53 -j ACCEPT 
-A stsrv2trn -p 6 --dport 53 -j ACCEPT 
-A stsrv2trn -j Reject
-A stsrv2trn -j ULOG --ulog-prefix "Shorewall:stsrv2trn:REJECT:" 
-A stsrv2trn -j reject
-A stsrv2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2ua -p 17 --dport 5353 -j ACCEPT 
-A stsrv2ua -p 17 --dport 53 -j ACCEPT 
-A stsrv2ua -p 6 --dport 53 -j ACCEPT 
-A stsrv2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A stsrv2vpn -p 17 --dport 5353 -j ACCEPT 
-A stsrv2vpn -p 17 --dport 53 -j ACCEPT 
-A stsrv2vpn -p 6 --dport 53 -j ACCEPT 
-A stsrv2vpn -j Reject
-A stsrv2vpn -j ULOG --ulog-prefix "Shorewall:stsrv2vpn:REJECT:" 
-A stsrv2vpn -j reject
-A tap0_fwd  -j dynamic
-A tap0_fwd -m state --state NEW,INVALID -j smurfs
-A tap0_fwd -p tcp -j tcpflags
-A tap0_fwd -o net70 -d 143.129.76.0/24 -j vpn2cln2
-A tap0_fwd -o net70 -d 143.129.75.0/24 -j vpn2cln3
-A tap0_fwd -o cln -j vpn2cln1
-A tap0_fwd -o srv -j vpn2srv
-A tap0_fwd -o lab -d 143.129.80.0/25 -j vpn2lab
-A tap0_fwd -o lab -d 143.129.80.128/25 -j vpn2stsrv
-A tap0_fwd -o trn -j vpn2trn
-A tap0_fwd -o net70 -d 143.129.0.0/16 -j vpn2ua
-A tap0_fwd -o net70 -d 143.169.0.0/16 -j vpn2ua
-A tap0_fwd -o net70 -d 146.175.0.0/16 -j vpn2ua
-A tap0_fwd -o net70 -j vpn2net
-A tap0_fwd -o net67 -j vpn2net
-A tap0_in  -j dynamic
-A tap0_in -m state --state NEW,INVALID -j smurfs
-A tap0_in -p tcp -j tcpflags
-A tap0_in -j vpn2fw
-A tap0_out -j fw2vpn
-A tcpflags -p tcp --tcp-flags ALL FIN,URG,PSH -j logflags
-A tcpflags -p tcp --tcp-flags ALL NONE        -j logflags
-A tcpflags -p tcp --tcp-flags SYN,RST SYN,RST -j logflags
-A tcpflags -p tcp --tcp-flags SYN,FIN SYN,FIN -j logflags
-A tcpflags -p tcp --syn --sport 0 -j logflags
-A trn2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2cln1 -p 17 --dport 5353 -j ACCEPT 
-A trn2cln1 -p 6 --dport 22 -j ACCEPT 
-A trn2cln1 -p 6 --dport 80 -j ACCEPT 
-A trn2cln1 -p 6 --dport 443 -j ACCEPT 
-A trn2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A trn2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A trn2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A trn2cln1 -p 17 --dport 53 -j ACCEPT 
-A trn2cln1 -p 6 --dport 53 -j ACCEPT 
-A trn2cln1 -j Reject
-A trn2cln1 -j ULOG --ulog-prefix "Shorewall:trn2cln1:REJECT:" 
-A trn2cln1 -j reject
-A trn2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2cln2 -p 17 --dport 5353 -j ACCEPT 
-A trn2cln2 -p 17 --dport 53 -j ACCEPT 
-A trn2cln2 -p 6 --dport 53 -j ACCEPT 
-A trn2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2cln3 -p 17 --dport 5353 -j ACCEPT 
-A trn2cln3 -p 17 --dport 53 -j ACCEPT 
-A trn2cln3 -p 6 --dport 53 -j ACCEPT 
-A trn2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2fw -p 17 --dport 5353 -j ACCEPT 
-A trn2fw -p 17 --dport 53 -j ACCEPT 
-A trn2fw -p 6 --dport 53 -j ACCEPT 
-A trn2fw -p 17 --dport 123 -j ACCEPT 
-A trn2fw -p 6 --dport 22 -j ACCEPT 
-A trn2fw -j Reject
-A trn2fw -j ULOG --ulog-prefix "Shorewall:trn2fw:REJECT:" 
-A trn2fw -j reject
-A trn2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2lab -p 17 --dport 5353 -j ACCEPT 
-A trn2lab -p 17 --dport 53 -j ACCEPT 
-A trn2lab -p 6 --dport 53 -j ACCEPT 
-A trn2lab -p 6 --dport 22 -o lab -j ACCEPT 
-A trn2lab -j Reject
-A trn2lab -j ULOG --ulog-prefix "Shorewall:trn2lab:REJECT:" 
-A trn2lab -j reject
-A trn2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2net -j ACCEPT
-A trn2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2srv -p 17 --dport 5353 -j ACCEPT 
-A trn2srv -p 17 --dport 53 -j ACCEPT 
-A trn2srv -p 6 --dport 53 -j ACCEPT 
-A trn2srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:trn2srv:DROP:" 
-A trn2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A trn2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:trn2srv:DROP:" 
-A trn2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A trn2srv -p 6 --dport 22 -j ACCEPT 
-A trn2srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A trn2srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A trn2srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A trn2srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A trn2srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -p 6 --dport 80 -s 10.0.0.253 -d 143.129.77.14 -j ACCEPT 
-A trn2srv -p 6 --dport 443 -s 10.0.0.253 -d 143.129.77.14 -j ACCEPT 
-A trn2srv -p 6 --dport 5000 -s 10.0.0.253 -d 143.129.77.14 -j ACCEPT 
-A trn2srv -p 6 --dport 10051 -s 10.0.0.253 -d 143.129.77.9 -j ACCEPT 
-A trn2srv -j Reject
-A trn2srv -j ULOG --ulog-prefix "Shorewall:trn2srv:REJECT:" 
-A trn2srv -j reject
-A trn2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2stsrv -p 17 --dport 5353 -j ACCEPT 
-A trn2stsrv -p 17 --dport 53 -j ACCEPT 
-A trn2stsrv -p 6 --dport 53 -j ACCEPT 
-A trn2stsrv -p 6 --dport 22 -o lab -j ACCEPT 
-A trn2stsrv -p 6 --dport 80 -o lab -j ACCEPT 
-A trn2stsrv -p 6 --dport 443 -o lab -j ACCEPT 
-A trn2stsrv -j Reject
-A trn2stsrv -j ULOG --ulog-prefix "Shorewall:trn2stsrv:REJECT:" 
-A trn2stsrv -j reject
-A trn2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2ua -p 17 --dport 5353 -j ACCEPT 
-A trn2ua -p 17 --dport 53 -j ACCEPT 
-A trn2ua -p 6 --dport 53 -j ACCEPT 
-A trn2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A trn2vpn -p 17 --dport 5353 -j ACCEPT 
-A trn2vpn -p 17 --dport 53 -j ACCEPT 
-A trn2vpn -p 6 --dport 53 -j ACCEPT 
-A trn2vpn -j Reject
-A trn2vpn -j ULOG --ulog-prefix "Shorewall:trn2vpn:REJECT:" 
-A trn2vpn -j reject
-A trn_fwd  -j dynamic
-A trn_fwd -j blacklst
-A trn_fwd -m state --state NEW,INVALID -j smurfs
-A trn_fwd -p tcp -j tcpflags
-A trn_fwd -o net70 -d 143.129.76.0/24 -j trn2cln2
-A trn_fwd -o net70 -d 143.129.75.0/24 -j trn2cln3
-A trn_fwd -o cln -j trn2cln1
-A trn_fwd -o tap0 -j trn2vpn
-A trn_fwd -o srv -j trn2srv
-A trn_fwd -o lab -d 143.129.80.0/25 -j trn2lab
-A trn_fwd -o lab -d 143.129.80.128/25 -j trn2stsrv
-A trn_fwd -o net70 -d 143.129.0.0/16 -j trn2ua
-A trn_fwd -o net70 -d 143.169.0.0/16 -j trn2ua
-A trn_fwd -o net70 -d 146.175.0.0/16 -j trn2ua
-A trn_fwd -o net70 -j trn2net
-A trn_fwd -o net67 -j trn2net
-A trn_in  -j dynamic
-A trn_in -j blacklst
-A trn_in -m state --state NEW,INVALID -j smurfs
-A trn_in -p udp --dport 67:68 -j ACCEPT
-A trn_in -p tcp -j tcpflags
-A trn_in -j trn2fw
-A trn_out -p udp --dport 67:68 -j ACCEPT
-A trn_out -j fw2trn
-A ua2all -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2all -j Drop
-A ua2all -j ULOG --ulog-prefix "Shorewall:ua2all:DROP:" 
-A ua2all -j DROP
-A ua2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2cln1 -p 17 --dport 5353 -j ACCEPT 
-A ua2cln1 -p 6 --dport 22 -j ACCEPT 
-A ua2cln1 -p 6 --dport 80 -j ACCEPT 
-A ua2cln1 -p 6 --dport 443 -j ACCEPT 
-A ua2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A ua2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A ua2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A ua2cln1 -p 17 --dport 53 -j ACCEPT 
-A ua2cln1 -p 6 --dport 53 -j ACCEPT 
-A ua2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2cln2 -p 17 --dport 5353 -j ACCEPT 
-A ua2cln2 -p 17 --dport 53 -j ACCEPT 
-A ua2cln2 -p 6 --dport 53 -j ACCEPT 
-A ua2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2cln3 -p 17 --dport 5353 -j ACCEPT 
-A ua2cln3 -p 17 --dport 53 -j ACCEPT 
-A ua2cln3 -p 6 --dport 53 -j ACCEPT 
-A ua2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2fw -p 17 --dport 5353 -j ACCEPT 
-A ua2fw -p 17 --dport 53 -j ACCEPT 
-A ua2fw -p 6 --dport 53 -j ACCEPT 
-A ua2fw -p 17 --dport 123 -j ACCEPT 
-A ua2fw -p 6 --dport 22 -j ACCEPT 
-A ua2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2lab -p 17 --dport 5353 -j ACCEPT 
-A ua2lab -p 17 --dport 53 -j ACCEPT 
-A ua2lab -p 6 --dport 53 -j ACCEPT 
-A ua2lab -p 6 --dport 22 -o lab -j ACCEPT 
-A ua2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2net -p 17 --dport 5353 -j ACCEPT 
-A ua2net -p 17 --dport 53 -j ACCEPT 
-A ua2net -p 6 --dport 53 -j ACCEPT 
-A ua2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2srv -p 17 --dport 5353 -j ACCEPT 
-A ua2srv -p 17 --dport 53 -j ACCEPT 
-A ua2srv -p 6 --dport 53 -j ACCEPT 
-A ua2srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A ua2srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A ua2srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A ua2srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A ua2srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A ua2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:ua2srv:DROP:" 
-A ua2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A ua2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:ua2srv:DROP:" 
-A ua2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A ua2srv -p 6 --dport 22 -j ACCEPT 
-A ua2srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A ua2srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A ua2srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A ua2srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A ua2srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A ua2srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A ua2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2stsrv -p 17 --dport 5353 -j ACCEPT 
-A ua2stsrv -p 17 --dport 53 -j ACCEPT 
-A ua2stsrv -p 6 --dport 53 -j ACCEPT 
-A ua2stsrv -p 6 --dport 22 -o lab -j ACCEPT 
-A ua2stsrv -p 6 --dport 80 -o lab -j ACCEPT 
-A ua2stsrv -p 6 --dport 443 -o lab -j ACCEPT 
-A ua2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2trn -p 17 --dport 5353 -j ACCEPT 
-A ua2trn -p 17 --dport 53 -j ACCEPT 
-A ua2trn -p 6 --dport 53 -j ACCEPT 
-A ua2vpn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A ua2vpn -p 17 --dport 5353 -j ACCEPT 
-A ua2vpn -p 17 --dport 53 -j ACCEPT 
-A ua2vpn -p 6 --dport 53 -j ACCEPT 
-A ua_frwd -o net70 -d 143.129.76.0/24 -j ua2cln2
-A ua_frwd -o net70 -d 143.129.75.0/24 -j ua2cln3
-A ua_frwd -o cln -j ua2cln1
-A ua_frwd -o tap0 -j ua2vpn
-A ua_frwd -o srv -j ua2srv
-A ua_frwd -o lab -d 143.129.80.0/25 -j ua2lab
-A ua_frwd -o lab -d 143.129.80.128/25 -j ua2stsrv
-A ua_frwd -o trn -j ua2trn
-A ua_frwd -o net70 -j ua2net
-A ua_frwd -o net67 -j ua2net
-A vpn2cln1 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2cln1 -p 17 --dport 5353 -j ACCEPT 
-A vpn2cln1 -p 6 --dport 22 -j ACCEPT 
-A vpn2cln1 -p 6 --dport 80 -j ACCEPT 
-A vpn2cln1 -p 6 --dport 443 -j ACCEPT 
-A vpn2cln1 -p 6 --dport 6881:6889 -o cln -j ACCEPT 
-A vpn2cln1 -p 17 --dport 6881 -o cln -j ACCEPT 
-A vpn2cln1 -p 6 --dport 5900:5909 -j ACCEPT 
-A vpn2cln1 -p 17 --dport 53 -j ACCEPT 
-A vpn2cln1 -p 6 --dport 53 -j ACCEPT 
-A vpn2cln1 -j Reject
-A vpn2cln1 -j ULOG --ulog-prefix "Shorewall:vpn2cln1:REJECT:" 
-A vpn2cln1 -j reject
-A vpn2cln2 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2cln2 -p 17 --dport 5353 -j ACCEPT 
-A vpn2cln2 -p 17 --dport 53 -j ACCEPT 
-A vpn2cln2 -p 6 --dport 53 -j ACCEPT 
-A vpn2cln3 -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2cln3 -p 17 --dport 5353 -j ACCEPT 
-A vpn2cln3 -p 17 --dport 53 -j ACCEPT 
-A vpn2cln3 -p 6 --dport 53 -j ACCEPT 
-A vpn2fw -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2fw -p 17 --dport 5353 -j ACCEPT 
-A vpn2fw -p 17 --dport 631 -j ACCEPT 
-A vpn2fw -p 17 --dport 53 -j ACCEPT 
-A vpn2fw -p 6 --dport 53 -j ACCEPT 
-A vpn2fw -p 17 --dport 123 -j ACCEPT 
-A vpn2fw -p 1 --icmp-type 8 -j ACCEPT 
-A vpn2fw -p 6 --dport 22 -j ACCEPT 
-A vpn2fw -j Reject
-A vpn2fw -j ULOG --ulog-prefix "Shorewall:vpn2fw:REJECT:" 
-A vpn2fw -j reject
-A vpn2lab -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2lab -p 17 --dport 5353 -j ACCEPT 
-A vpn2lab -p 17 --dport 53 -j ACCEPT 
-A vpn2lab -p 6 --dport 53 -j ACCEPT 
-A vpn2lab -p 6 --dport 22 -o lab -j ACCEPT 
-A vpn2lab -j Reject
-A vpn2lab -j ULOG --ulog-prefix "Shorewall:vpn2lab:REJECT:" 
-A vpn2lab -j reject
-A vpn2net -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2net -j ACCEPT
-A vpn2srv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2srv -p 17 --dport 5353 -j ACCEPT 
-A vpn2srv -p 17 --dport 53 -j ACCEPT 
-A vpn2srv -p 6 --dport 53 -j ACCEPT 
-A vpn2srv -p 6 --dport 143 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 993 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 631 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 631 -d 143.129.77.2 -j ACCEPT 
-A vpn2srv -p 6 --dport 9100 -d 143.129.77.2 -j ACCEPT 
-A vpn2srv -p 17 --dport 123 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 3389 -d 143.129.77.5 -j ACCEPT 
-A vpn2srv -p 1 --icmp-type 8 -j ACCEPT 
-A vpn2srv -p 17 -m multiport --dports 135,445 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 17 --dport 137:139 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 17 --dport 1024:65535 --sport 137 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 -m multiport --dports 135,139,445 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 25 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 465 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 22 -d 143.129.77.11 -j ACCEPT 
-A vpn2srv -p 6 --dport 22 -d 143.129.77.3 -j ACCEPT 
-A vpn2srv -p 6 --dport 22 -d 143.129.77.11 -j ULOG --ulog-prefix "Shorewall:vpn2srv:DROP:" 
-A vpn2srv -p 6 --dport 22 -d 143.129.77.11 -j DROP 
-A vpn2srv -p 6 --dport 22 -d 143.129.77.3 -j ULOG --ulog-prefix "Shorewall:vpn2srv:DROP:" 
-A vpn2srv -p 6 --dport 22 -d 143.129.77.3 -j DROP 
-A vpn2srv -p 6 --dport 22 -j ACCEPT 
-A vpn2srv -p 6 --dport 80 -d 143.129.77.1 -j ACCEPT 
-A vpn2srv -p 6 --dport 80 -d 143.129.77.7 -j ACCEPT 
-A vpn2srv -p 6 --dport 80 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 443 -d 143.129.77.1 -j ACCEPT 
-A vpn2srv -p 6 --dport 443 -d 143.129.77.7 -j ACCEPT 
-A vpn2srv -p 6 --dport 443 -d 143.129.77.9 -j ACCEPT 
-A vpn2srv -p 6 --dport 80 -d 143.129.77.12 -j ACCEPT 
-A vpn2srv -p 6 --dport 80 -d 143.129.77.14 -j ACCEPT 
-A vpn2srv -p 6 --dport 443 -d 143.129.77.12 -j ACCEPT 
-A vpn2srv -p 6 --dport 443 -d 143.129.77.14 -j ACCEPT 
-A vpn2srv -j Reject
-A vpn2srv -j ULOG --ulog-prefix "Shorewall:vpn2srv:REJECT:" 
-A vpn2srv -j reject
-A vpn2stsrv -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2stsrv -p 17 --dport 5353 -j ACCEPT 
-A vpn2stsrv -p 17 --dport 53 -j ACCEPT 
-A vpn2stsrv -p 6 --dport 53 -j ACCEPT 
-A vpn2stsrv -p 6 --dport 22 -o lab -j ACCEPT 
-A vpn2stsrv -p 6 --dport 80 -o lab -j ACCEPT 
-A vpn2stsrv -p 6 --dport 443 -o lab -j ACCEPT 
-A vpn2stsrv -j Reject
-A vpn2stsrv -j ULOG --ulog-prefix "Shorewall:vpn2stsrv:REJECT:" 
-A vpn2stsrv -j reject
-A vpn2trn -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2trn -j ACCEPT
-A vpn2ua -m state --state ESTABLISHED,RELATED -j ACCEPT
-A vpn2ua -p 17 --dport 5353 -j ACCEPT 
-A vpn2ua -p 17 --dport 53 -j ACCEPT 
-A vpn2ua -p 6 --dport 53 -j ACCEPT 
COMMIT
__EOF__

    exec 3>&-

    [ -n "$DEBUG" ] && command=debug_restore_input || command=$IPTABLES_RESTORE

    progress_message2 "Running $command..."

    cat ${VARDIR}/.iptables-restore-input | $command # Use this nonsensical form to appease SELinux
    if [ $? != 0 ]; then
	fatal_error "iptables-restore Failed. Input is in ${VARDIR}/.iptables-restore-input"
    fi

}

chainlist_reload()
{
    
    progress_message2 Preparing iptables-restore input for chain blacklst...

    exec 3>${VARDIR}/.iptables-restore-input

    cat >&3 << __EOF__
*filter
:blacklst - [0:0]
COMMIT
__EOF__

    exec 3>&-

    progress_message2 "Running iptables-restore..."

    cat ${VARDIR}/.iptables-restore-input | $IPTABLES_RESTORE -n # Use this nonsensical form to appease SELinux
    if [ $? != 0 ]; then
	fatal_error "iptables-restore Failed. Input is in ${VARDIR}/.iptables-restore-input"
    fi

}

#
# Start/Restart the Firewall
#
define_firewall() {
    
    clear_routing_and_traffic_shaping
    #
    # Establish the values of shell variables used in the following function calls
    #
    NET70_ADDRESS=$(find_first_interface_address net70)
    NET67_ADDRESS=$(find_first_interface_address net67)
    if [ "$COMMAND" != restore ]; then

	TRN_NETWORKS=$(get_routed_networks trn)
	[ -n "$TRN_NETWORKS" ] || fatal_error "Unable to determine the routes through interface \"trn\""

    fi

    setup_routing_and_traffic_shaping
    
    if [ $COMMAND = restore ]; then
	iptables_save_file=${VARDIR}/$(basename $0)-iptables
	if [ -f $iptables_save_file ]; then
	    cat $iptables_save_file | $IPTABLES_RESTORE # Use this nonsensical form to appease SELinux
	else
	    fatal_error "$iptables_save_file does not exist"
	fi

	echo 1 > /proc/sys/net/ipv4/ip_forward
	progress_message2 IP Forwarding Enabled

	set_state "Started"
    else
	if [ $COMMAND = refresh ]; then
	    chainlist_reload

	    echo 1 > /proc/sys/net/ipv4/ip_forward
	    progress_message2 IP Forwarding Enabled

	    run_refreshed_exit
	    do_iptables -N shorewall
	    set_state "Started"
	else
	    setup_netfilter
	    restore_dynamic_rules

	    echo 1 > /proc/sys/net/ipv4/ip_forward
	    progress_message2 IP Forwarding Enabled

	    run_start_exit
	    do_iptables -N shorewall
	    set_state "Started"
	    run_started_exit
	fi
    
	cp -f $(my_pathname) ${VARDIR}/.restore
    fi
    
    date > ${VARDIR}/restarted
    
    case $COMMAND in
	start)
	    logger -p kern.info "$PRODUCT started"
	    ;;
	restart)
	    logger -p kern.info "$PRODUCT restarted"
	    ;;
	refresh)
	    logger -p kern.info "$PRODUCT refreshed"
	    ;;
	restore)
	    logger -p kern.info "$PRODUCT restored"
	    ;;
    esac

}

#
# Give Usage Information
#
usage() {
    echo "Usage: $0 [ -q ] [ -v ] [ -n ] [ start|stop|clear|reset|refresh|restart|status|version ]"
    exit $1
}
################################################################################
# E X E C U T I O N    B E G I N S   H E R E				       #
################################################################################
#
# Start trace if first arg is "debug" or "trace"
#
if [ $# -gt 1 ]; then 
    if [ "x$1" = "xtrace" ]; then
	set -x
	shift
    elif [ "x$1" = "xdebug" ]; then
	DEBUG=Yes
	shift
    fi
fi

initialize

finished=0

while [ $finished -eq 0 -a $# -gt 0 ]; do
    option=$1
    case $option in
	-*)
	    option=${option#-}

	    [ -z "$option" ] && usage 1

	    while [ -n "$option" ]; do
		case $option in
		    v*)
			VERBOSE=$(($VERBOSE + 1 ))
			option=${option#v}
			;;
		    q*)
			VERBOSE=$(($VERBOSE - 1 ))
			option=${option#q}
			;;
		    n*)
			NOROUTES=Yes
			option=${option#n}
			;;
		    *)
			usage 1
			;;
		esac
	    done
	    shift
	    ;;
	*)
	    finished=1
            ;;
    esac
done

if [ $# -ne 1 ]; then
    usage 2
else
    COMMAND="$1"
fi

[ -n "${PRODUCT:=Shorewall}" ]

case "$COMMAND" in
    start)
	if shorewall_is_started; then
	    error_message "$PRODUCT is already Running"
	    status=0
	else
	    progress_message3 "Starting $PRODUCT...."
	    define_firewall
	    status=$?
	    [ -n "$SUBSYSLOCK" -a $status -eq 0 ] && touch $SUBSYSLOCK
	    progress_message3 "done."
	fi
	;;
    stop)
	progress_message3 "Stopping $PRODUCT...."
	stop_firewall
	status=0
	[ -n "$SUBSYSLOCK" ] && rm -f $SUBSYSLOCK
	progress_message3 "done."
	;;
    reset)
	if ! shorewall_is_started ; then
	    error_message "$PRODUCT is not running"
	    status=2
	else
	    $IPTABLES -Z
	    $IPTABLES -t nat -Z
	    $IPTABLES -t mangle -Z
	    date > ${VARDIR}/restarted
	    status=0
	    progress_message3 "$PRODUCT Counters Reset"
	fi
	;;
    restart)
	if shorewall_is_started; then
	    progress_message3 "Restarting $PRODUCT...."
	else
	    error_message "$PRODUCT is not running"
	    progress_message3 "Starting $PRODUCT...."
	fi

	define_firewall
	status=$?
	if [ -n "$SUBSYSLOCK" ]; then
 	    [ $status -eq 0 ] && touch $SUBSYSLOCK || rm -f $SUBSYSLOCK
        fi
	progress_message3 "done."
	;;
    refresh)
	if shorewall_is_started; then
	    progress_message3 "Refreshing $PRODUCT...."
	    define_firewall
	    status=$?
	    progress_message3 "done."
	else
	    echo "$PRODUCT is not running" >&2
	    status=2
	fi
	;;
    restore)
	define_firewall
	status=$?
	if [ -n "$SUBSYSLOCK" ]; then
 	    [ $status -eq 0 ] && touch $SUBSYSLOCK || rm -f $SUBSYSLOCK
        fi
	;;
    clear)
	progress_message3 "Clearing $PRODUCT...."
	clear_firewall
	status=0
	[ -n "$SUBSYSLOCK" ] && rm -f $SUBSYSLOCK
	progress_message3 "done."
	;;
    status)
	echo "$PRODUCT-$VERSION Status at $HOSTNAME - $(date)"
	echo
	if shorewall_is_started; then
	    echo "$PRODUCT is running"
	    status=0
	else
	    echo "$PRODUCT is stopped"
	    status=4
	fi

	if [ -f ${VARDIR}/state ]; then
	    state="$(cat ${VARDIR}/state)"
	    case $state in
		Stopped*|Clear*)
		    status=3
		    ;;
	    esac
	else
	    state=Unknown
	fi
	echo "State:$state"
	echo
	;;
    version)
	echo $VERSION
	status=0
	;;
    help)
	usage 0
	;;
    *)
	usage 2
	;;
esac

exit $status
